<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pokemon Learning Quest v3.0</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
      background-color: #ffffff;
      min-height: 100%;
    }
    
    .pokeball-btn {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 5px solid #000;
      background: linear-gradient(180deg, #ef4444 0%, #ef4444 48%, #000 48%, #000 52%, #fff 52%, #fff 100%);
      cursor: pointer;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .pokeball-btn:hover {
      transform: scale(1.1);
    }
    
    .pokeball-btn::before {
      content: '';
      position: absolute;
      width: 25px;
      height: 25px;
      background: #fff;
      border: 4px solid #000;
      border-radius: 50%;
      z-index: 2;
    }
    
    .pokeball-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 5px;
      background: #000;
      transform: translateY(-50%);
      z-index: 1;
    }
    
    .pokemon-card {
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .pokemon-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .capture-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: captureAnim 1s ease-out;
      z-index: 999;
    }
    
    @keyframes captureAnim {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
      }
    }
    
    .rarity-common { border-color: #9ca3af; }
    .rarity-uncommon { border-color: #10b981; }
    .rarity-rare { border-color: #3b82f6; }
    .rarity-legendary { border-color: #a855f7; }
    .rarity-mythical { border-color: #f59e0b; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full">
  <div id="app" class="min-h-full p-4"></div>
  <script>
    const defaultConfig = {
      game_title: "Pokemon Learning Quest v3.0",
      welcome_message: "Selamat datang di Pokemon Learning Quest!",
      menu_quiz: "Soal",
      menu_collection: "Koleksi",
      menu_duel: "Duel",
      menu_backup: "Backup",
      primary_color: "#ef4444",
      secondary_color: "#3b82f6",
      text_color: "#1f2937",
      background_color: "#ffffff",
      surface_color: "#ffffff"
    };

    let allPokemonData = [];
    let questions = [];
    let stats = {
      totalAnswered: 0,
      correctAnswers: 0,
      wrongStreak: 0,
      totalCaptured: 0
    };
    let currentView = 'home';
    let secretKeyPressed = false;

    const dataHandler = {
      onDataChanged(data) {
        allPokemonData = data;
        if (currentView === 'collection') {
          renderCollectionView();
        }
        updateStats();
      }
    };

    let useOfflineMode = false;

    async function init() {
      loadLocalData();
      
      await new Promise(resolve => setTimeout(resolve, 100));
      
      if (window.dataSdk) {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error("Failed to initialize data SDK");
          useOfflineMode = true;
          loadOfflineData();
          showToast('Mode Offline: Data disimpan di browser', 'info');
        }
      } else {
        console.error("Data SDK not available - using offline mode");
        useOfflineMode = true;
        loadOfflineData();
        showToast('Mode Offline: Data disimpan di browser', 'info');
      }

      renderHome();
      
      document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'm') {
          secretKeyPressed = true;
        }
      });
      
      document.addEventListener('keyup', (e) => {
        if (e.key.toLowerCase() === 'm') {
          secretKeyPressed = false;
        }
      });
      
      document.addEventListener('click', (e) => {
        if (secretKeyPressed) {
          openQuestionEditor();
        }
      });
      
      let longPressTimer;
      document.addEventListener('touchstart', (e) => {
        longPressTimer = setTimeout(() => {
          openQuestionEditor();
        }, 1000);
      });
      
      document.addEventListener('touchend', () => {
        clearTimeout(longPressTimer);
      });
      
      document.addEventListener('touchmove', () => {
        clearTimeout(longPressTimer);
      });
    }

    function loadLocalData() {
      const savedQuestions = localStorage.getItem('pokemon_questions');
      if (savedQuestions) {
        questions = JSON.parse(savedQuestions);
      } else {
        questions = [
          {
            id: '1',
            question: 'Berapa hasil dari 2 + 2?',
            answer: '4',
            topic: 'Matematika',
            difficulty: 'very_easy',
            rarity: 'common'
          },
          {
            id: '2',
            question: 'Berapa hasil dari 5 + 3?',
            answer: '8',
            topic: 'Matematika',
            difficulty: 'easy',
            rarity: 'uncommon'
          },
          {
            id: '3',
            question: 'Apa ibu kota Indonesia?',
            answer: 'Jakarta',
            topic: 'Geografi',
            difficulty: 'easy',
            rarity: 'uncommon'
          }
        ];
      }
      
      const savedStats = localStorage.getItem('pokemon_stats');
      if (savedStats) {
        stats = JSON.parse(savedStats);
      }
    }

    function loadOfflineData() {
      const savedPokemon = localStorage.getItem('pokemon_offline_data');
      if (savedPokemon) {
        allPokemonData = JSON.parse(savedPokemon);
      }
    }

    function saveOfflineData() {
      localStorage.setItem('pokemon_offline_data', JSON.stringify(allPokemonData));
      updateStats();
    }

    function saveLocalData() {
      localStorage.setItem('pokemon_questions', JSON.stringify(questions));
      localStorage.setItem('pokemon_stats', JSON.stringify(stats));
    }

    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function updateStats() {
      stats.totalCaptured = allPokemonData.length;
      saveLocalData();
      
      const statsEl = document.getElementById('stats-display');
      if (statsEl) {
        statsEl.innerHTML = `
          <div class="text-sm">
            <span class="font-bold">Soal Dijawab:</span> ${stats.totalAnswered} | 
            <span class="font-bold">Benar:</span> ${stats.correctAnswers} | 
            <span class="font-bold">Pokemon:</span> ${stats.totalCaptured}
          </div>
        `;
      }
    }

    async function capturePokemon(rarity = 'common') {
      const rarityRanges = {
        common: { hp: [20, 45], atk: [15, 40], speed: [15, 35], totalMin: 0, totalMax: 299 },
        uncommon: { hp: [40, 65], atk: [35, 60], speed: [30, 55], totalMin: 300, totalMax: 399 },
        rare: { hp: [60, 90], atk: [55, 80], speed: [50, 75], totalMin: 400, totalMax: 499 },
        legendary: { hp: [85, 120], atk: [75, 110], speed: [70, 100], totalMin: 500, totalMax: 579 },
        mythical: { hp: [100, 150], atk: [95, 135], speed: [85, 120], totalMin: 580, totalMax: 999 }
      };
      
      function randomStat(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }
      
      // Validasi rarity
      if (!rarityRanges[rarity]) {
        console.error('Invalid rarity:', rarity);
        rarity = 'common';
      }
      
      const targetRange = rarityRanges[rarity];
      let attempts = 0;
      let data = null;
      
      while (attempts < 20) {
        const randomId = Math.floor(Math.random() * 1010) + 1;
        
        try {
          const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`);
          if (!response.ok) throw new Error('Network error');
          data = await response.json();
          
          // Validasi data.stats ada
          if (!data.stats || !Array.isArray(data.stats)) {
            throw new Error('Invalid stats data');
          }
          
          const totalStats = data.stats.reduce((sum, stat) => sum + stat.base_stat, 0);
          
          if (totalStats >= targetRange.totalMin && totalStats <= targetRange.totalMax) {
            break;
          }
        } catch (error) {
          console.log('Fetch attempt failed:', error);
        }
        
        attempts++;
      }
      
      if (!data || !data.sprites || !data.id) {
        showToast('Gagal menangkap Pokemon, coba lagi!', 'error');
        return;
      }
      
      const finalRarity = rarity;
      
      const code = `PKM-${String(data.id).padStart(3, '0')}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
      
      const ranges = rarityRanges[finalRarity];
      
      const imageUrl = data.sprites.front_default || 
                       (data.sprites.other && data.sprites.other['official-artwork'] && data.sprites.other['official-artwork'].front_default) ||
                       `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${data.id}.png`;
      
      const newPokemon = {
        pokemon_id: data.id,
        name: capitalizeFirst(data.name || 'Unknown'),
        image: imageUrl,
        code: code,
        hp: randomStat(ranges.hp[0], ranges.hp[1]),
        atk: randomStat(ranges.atk[0], ranges.atk[1]),
        speed: randomStat(ranges.speed[0], ranges.speed[1]),
        rarity: finalRarity,
        captured_at: new Date().toISOString()
      };
      
      const duplicates = allPokemonData.filter(p => p.pokemon_id === newPokemon.pokemon_id);
      
      if (duplicates.length >= 1) {
        showDuplicateModal(newPokemon, duplicates[0]);
      } else {
        if (useOfflineMode) {
          newPokemon.__backendId = `offline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          allPokemonData.push(newPokemon);
          saveOfflineData();
          showCaptureAnimation(newPokemon);
          showCaptureSuccessModal(newPokemon);
        } else {
          const result = await window.dataSdk.create(newPokemon);
          if (result.isOk) {
            showCaptureAnimation(newPokemon);
            showCaptureSuccessModal(newPokemon);
          } else {
            showToast(`Gagal menyimpan ${newPokemon.name}: ${result.error.message}`, 'error');
          }
        }
      }
    }

    function showCaptureAnimation(pokemon) {
      const anim = document.createElement('div');
      anim.className = 'capture-animation';
      anim.innerHTML = `
        <div class="text-center">
          <img src="${pokemon.image}" alt="${pokemon.name}" class="w-32 h-32 mx-auto">
          <div class="text-2xl font-bold mt-2" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">${pokemon.name}</div>
        </div>
      `;
      document.body.appendChild(anim);
      
      setTimeout(() => {
        anim.remove();
      }, 1000);
    }

    function showCaptureSuccessModal(pokemon) {
      const config = window.elementSdk?.config || defaultConfig;
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4';
      modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
      
      const rarityColors = {
        common: '#9ca3af',
        uncommon: '#10b981',
        rare: '#3b82f6',
        legendary: '#a855f7',
        mythical: '#f59e0b'
      };
      
      modal.innerHTML = `
        <div class="rounded-lg p-6 max-w-md w-full" style="background-color: ${config.surface_color}">
          <div class="text-center mb-4">
            <div class="text-3xl font-bold mb-2" style="color: ${config.primary_color}">üéâ Pokemon Tertangkap! üéâ</div>
          </div>
          
          <img src="${pokemon.image}" alt="${pokemon.name}" class="w-48 h-48 mx-auto mb-4">
          
          <div class="text-center mb-4">
            <div class="text-2xl font-bold mb-2" style="color: ${config.text_color}">${pokemon.name}</div>
            <div class="inline-block px-4 py-2 rounded-full text-white font-bold mb-3" style="background-color: ${rarityColors[pokemon.rarity]}">${pokemon.rarity.toUpperCase()}</div>
            
            <div class="bg-gray-100 p-4 rounded-lg mb-3">
              <div class="grid grid-cols-3 gap-2 text-center">
                <div>
                  <div class="text-2xl font-bold" style="color: ${config.primary_color}">${pokemon.hp}</div>
                  <div class="text-sm" style="color: ${config.text_color}">HP</div>
                </div>
                <div>
                  <div class="text-2xl font-bold" style="color: ${config.primary_color}">${pokemon.atk}</div>
                  <div class="text-sm" style="color: ${config.text_color}">ATK</div>
                </div>
                <div>
                  <div class="text-2xl font-bold" style="color: ${config.primary_color}">${pokemon.speed}</div>
                  <div class="text-sm" style="color: ${config.text_color}">SPEED</div>
                </div>
              </div>
            </div>
            
            <div class="bg-gray-100 p-3 rounded mb-2 flex items-center justify-between">
              <div class="font-mono text-sm" style="color: ${config.text_color}">${pokemon.code}</div>
              <button id="copy-code-btn" class="px-3 py-1 rounded text-sm font-bold text-white" style="background-color: ${config.secondary_color}">Salin</button>
            </div>
          </div>
          
          <button id="close-capture-modal" class="w-full py-3 rounded-lg font-bold text-white" style="background-color: ${config.primary_color}">Tutup</button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('copy-code-btn').onclick = () => {
        navigator.clipboard.writeText(pokemon.code);
        showToast('Kode Pokemon disalin!', 'success');
      };
      
      document.getElementById('close-capture-modal').onclick = () => {
        modal.remove();
      };
    }

    function showDuplicateModal(newPokemon, existingPokemon) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50';
      modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
      
      modal.innerHTML = `
        <div class="rounded-lg p-6 max-w-2xl w-full mx-4" style="background-color: ${window.elementSdk?.config?.surface_color || defaultConfig.surface_color}">
          <h3 class="text-xl font-bold mb-4" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">Pokemon Duplikat!</h3>
          <p class="mb-4" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">Kamu sudah memiliki ${newPokemon.name}. Pilih yang ingin disimpan:</p>
          
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="border-2 p-4 rounded cursor-pointer hover:shadow-lg" id="keep-new">
              <img src="${newPokemon.image}" alt="${newPokemon.name}" class="w-24 h-24 mx-auto">
              <div class="text-center mt-2">
                <div class="font-bold" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">${newPokemon.name} (Baru)</div>
                <div class="text-sm" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">HP: ${newPokemon.hp} | ATK: ${newPokemon.atk} | SPD: ${newPokemon.speed}</div>
              </div>
            </div>
            
            <div class="border-2 p-4 rounded cursor-pointer hover:shadow-lg" id="keep-old">
              <img src="${existingPokemon.image}" alt="${existingPokemon.name}" class="w-24 h-24 mx-auto">
              <div class="text-center mt-2">
                <div class="font-bold" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">${existingPokemon.name} (Lama)</div>
                <div class="text-sm" style="color: ${window.elementSdk?.config?.text_color || defaultConfig.text_color}">HP: ${existingPokemon.hp} | ATK: ${existingPokemon.atk} | SPD: ${existingPokemon.speed}</div>
              </div>
            </div>
          </div>
          
          <button id="cancel-duplicate" class="w-full py-2 rounded font-bold" style="background-color: ${window.elementSdk?.config?.secondary_color || defaultConfig.secondary_color}; color: white">Batal</button>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('keep-new').onclick = async () => {
        if (useOfflineMode) {
          const index = allPokemonData.findIndex(p => p.__backendId === existingPokemon.__backendId);
          if (index !== -1) {
            allPokemonData.splice(index, 1);
          }
          newPokemon.__backendId = `offline_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          allPokemonData.push(newPokemon);
          saveOfflineData();
        } else {
          await window.dataSdk.delete(existingPokemon);
          await window.dataSdk.create(newPokemon);
        }
        showToast(`Menyimpan ${newPokemon.name} yang baru`, 'success');
        modal.remove();
      };
      
      document.getElementById('keep-old').onclick = () => {
        showToast(`Mempertahankan ${existingPokemon.name} yang lama`, 'info');
        modal.remove();
      };
      
      document.getElementById('cancel-duplicate').onclick = () => {
        modal.remove();
      };
    }

    async function releasePokemon() {
      if (allPokemonData.length === 0) return;
      
      const randomIndex = Math.floor(Math.random() * allPokemonData.length);
      const pokemon = allPokemonData[randomIndex];
      
      if (useOfflineMode) {
        allPokemonData.splice(randomIndex, 1);
        saveOfflineData();
        showToast(`${pokemon.name} telah dilepas`, 'error');
      } else {
        const result = await window.dataSdk.delete(pokemon);
        if (result.isOk) {
          showToast(`${pokemon.name} telah dilepas`, 'error');
        }
      }
    }

    function renderHome() {
      currentView = 'home';
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-4xl mx-auto">
          <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2" style="color: ${config.text_color}">${config.game_title}</h1>
            <p class="text-lg" style="color: ${config.text_color}">${config.welcome_message}</p>
          </div>
          
          <div id="stats-display" class="text-center mb-8 p-4 rounded" style="background-color: ${config.surface_color}"></div>
          
          <div class="grid grid-cols-2 md:grid-cols-5 gap-6 mb-8">
            <div class="text-center">
              <button class="pokeball-btn mx-auto mb-2" id="btn-quiz"></button>
              <div class="font-bold" style="color: ${config.text_color}">${config.menu_quiz}</div>
            </div>
            
            <div class="text-center">
              <button class="pokeball-btn mx-auto mb-2" id="btn-collection"></button>
              <div class="font-bold" style="color: ${config.text_color}">${config.menu_collection}</div>
            </div>
            
            <div class="text-center">
              <button class="pokeball-btn mx-auto mb-2" id="btn-duel"></button>
              <div class="font-bold" style="color: ${config.text_color}">${config.menu_duel}</div>
            </div>
            
            <div class="text-center">
              <button class="pokeball-btn mx-auto mb-2" id="btn-backup"></button>
              <div class="font-bold" style="color: ${config.text_color}">${config.menu_backup}</div>
            </div>
            
            <div class="text-center">
              <button class="pokeball-btn mx-auto mb-2" id="btn-settings"></button>
              <div class="font-bold" style="color: ${config.text_color}">Settings</div>
            </div>
          </div>
        </div>
      `;
      
      updateStats();
      
      document.getElementById('btn-quiz').onclick = renderQuizView;
      document.getElementById('btn-collection').onclick = renderCollectionView;
      document.getElementById('btn-duel').onclick = renderDuelView;
      document.getElementById('btn-backup').onclick = renderBackupView;
      document.getElementById('btn-settings').onclick = renderSettingsView;
    }

    let selectedTopic = 'all';
    let selectedDifficulty = 'all';

    function renderQuizView() {
      currentView = 'quiz';
      const config = window.elementSdk?.config || defaultConfig;
      
      if (questions.length === 0) {
        showToast('Belum ada soal. Tambahkan soal melalui Editor Soal.', 'error');
        return;
      }
      
      const topics = ['all', ...new Set(questions.map(q => q.topic))];
      const difficulties = ['all', 'very_easy', 'easy', 'medium', 'hard', 'very_hard'];
      const difficultyLabels = {
        all: 'Semua Tingkat',
        very_easy: 'Sangat Mudah',
        easy: 'Mudah',
        medium: 'Sedang',
        hard: 'Sulit',
        very_hard: 'Sangat Sulit'
      };
      
      let filteredQuestions = questions;
      if (selectedTopic !== 'all') {
        filteredQuestions = filteredQuestions.filter(q => q.topic === selectedTopic);
      }
      if (selectedDifficulty !== 'all') {
        filteredQuestions = filteredQuestions.filter(q => q.difficulty === selectedDifficulty);
      }
      
      if (filteredQuestions.length === 0) {
        showToast('Tidak ada soal dengan filter ini', 'error');
        selectedTopic = 'all';
        selectedDifficulty = 'all';
        filteredQuestions = questions;
      }
      
      const randomQuestion = filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-2xl mx-auto">
          <button id="btn-back" class="mb-4 px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
          
          <div id="stats-display" class="mb-4 p-4 rounded" style="background-color: ${config.surface_color}"></div>
          
          <div class="mb-4 p-4 rounded-lg shadow-lg" style="background-color: ${config.surface_color}">
            <div class="font-bold mb-2" style="color: ${config.text_color}">Filter Soal:</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1" style="color: ${config.text_color}">Topik:</label>
                <select id="topic-filter" class="w-full p-2 border-2 rounded" style="border-color: ${config.secondary_color}">
                  ${topics.map(t => `<option value="${t}" ${t === selectedTopic ? 'selected' : ''}>${t === 'all' ? 'Semua Topik' : t}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block text-sm mb-1" style="color: ${config.text_color}">Kesulitan:</label>
                <select id="difficulty-filter" class="w-full p-2 border-2 rounded" style="border-color: ${config.secondary_color}">
                  ${difficulties.map(d => `<option value="${d}" ${d === selectedDifficulty ? 'selected' : ''}>${difficultyLabels[d]}</option>`).join('')}
                </select>
              </div>
            </div>
          </div>
          
          <div class="p-6 rounded-lg shadow-lg" style="background-color: ${config.surface_color}">
            <div class="mb-4">
              <span class="px-3 py-1 rounded text-sm font-bold" style="background-color: ${config.primary_color}; color: white">${randomQuestion.topic}</span>
              <span class="ml-2 px-3 py-1 rounded text-sm font-bold" style="background-color: ${config.secondary_color}; color: white">${randomQuestion.difficulty}</span>
            </div>
            
            <h2 class="text-2xl font-bold mb-4" style="color: ${config.text_color}">${randomQuestion.question}</h2>
            
            <input type="text" id="answer-input" placeholder="Ketik jawabanmu..." class="w-full p-3 border-2 rounded mb-4" style="border-color: ${config.secondary_color}">
            
            <button id="btn-submit" class="w-full py-3 rounded-lg font-bold text-white" style="background-color: ${config.primary_color}">Kirim Jawaban</button>
          </div>
        </div>
      `;
      
      updateStats();
      
      document.getElementById('btn-back').onclick = renderHome;
      
      document.getElementById('topic-filter').onchange = (e) => {
        selectedTopic = e.target.value;
        renderQuizView();
      };
      
      document.getElementById('difficulty-filter').onchange = (e) => {
        selectedDifficulty = e.target.value;
        renderQuizView();
      };
      
      const answerInput = document.getElementById('answer-input');
      const submitBtn = document.getElementById('btn-submit');
      
      answerInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitBtn.click();
        }
      });
      
      submitBtn.onclick = () => {
        const userAnswer = answerInput.value.trim().toLowerCase();
        const correctAnswer = randomQuestion.answer.toLowerCase();
        
        stats.totalAnswered++;
        
        if (userAnswer === correctAnswer) {
          stats.correctAnswers++;
          stats.wrongStreak = 0;
          showToast('Jawaban Benar! üéâ', 'success');
          capturePokemon(randomQuestion.rarity);
          setTimeout(() => renderQuizView(), 1500);
        } else {
          stats.wrongStreak++;
          showToast('Jawaban Salah! ‚ùå', 'error');
          
          if (stats.wrongStreak >= 3) {
            stats.wrongStreak = 0;
            if (allPokemonData.length > 0) {
              releasePokemon();
              showToast('‚ö†Ô∏è 3x Salah! 1 Pokemon dilepas!', 'error');
            }
          }
          
          setTimeout(() => renderQuizView(), 2000);
        }
        
        saveLocalData();
      };
      
      answerInput.focus();
    }

    function renderCollectionView() {
      currentView = 'collection';
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-6xl mx-auto">
          <button id="btn-back" class="mb-4 px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
          
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.text_color}">Koleksi Pokemon (${allPokemonData.length})</h2>
          
          <div id="pokemon-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
      `;
      
      document.getElementById('btn-back').onclick = renderHome;
      
      const grid = document.getElementById('pokemon-grid');
      
      if (allPokemonData.length === 0) {
        grid.innerHTML = `<div class="col-span-full text-center py-12" style="color: ${config.text_color}">Belum ada Pokemon. Jawab soal untuk menangkap Pokemon!</div>`;
        return;
      }
      
      allPokemonData.forEach(pokemon => {
        const card = document.createElement('div');
        card.className = `pokemon-card p-4 rounded-lg shadow-lg cursor-pointer border-4 rarity-${pokemon.rarity}`;
        card.style.backgroundColor = config.surface_color;
        
        card.innerHTML = `
          <img src="${pokemon.image}" alt="${pokemon.name}" class="w-full h-32 object-contain mb-2">
          <div class="text-center">
            <div class="font-bold text-lg" style="color: ${config.text_color}">${pokemon.name}</div>
            <div class="flex items-center justify-center gap-1 mb-2">
              <div class="text-xs font-mono" style="color: ${config.text_color}">${pokemon.code}</div>
              <button class="copy-code-btn px-2 py-1 rounded text-xs font-bold text-white" style="background-color: ${config.secondary_color}" data-code="${pokemon.code}">üìã</button>
            </div>
            <div class="text-sm" style="color: ${config.text_color}">HP: ${pokemon.hp} | ATK: ${pokemon.atk} | SPD: ${pokemon.speed}</div>
            <div class="text-xs mt-1 font-bold" style="color: ${config.text_color}">${pokemon.rarity.toUpperCase()}</div>
          </div>
        `;
        
        card.onclick = (e) => {
          if (!e.target.classList.contains('copy-code-btn')) {
            showPokemonDetail(pokemon);
          }
        };
        
        const copyBtn = card.querySelector('.copy-code-btn');
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          navigator.clipboard.writeText(pokemon.code);
          showToast('Kode Pokemon disalin!', 'success');
        };
        
        grid.appendChild(card);
      });
    }

    function showPokemonDetail(pokemon) {
      const config = window.elementSdk?.config || defaultConfig;
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50';
      modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
      
      modal.innerHTML = `
        <div class="rounded-lg p-6 max-w-md w-full mx-4" style="background-color: ${config.surface_color}">
          <img src="${pokemon.image}" alt="${pokemon.name}" class="w-48 h-48 mx-auto mb-4">
          <h3 class="text-2xl font-bold text-center mb-2" style="color: ${config.text_color}">${pokemon.name}</h3>
          <div class="text-center mb-4" style="color: ${config.text_color}">
            <div class="font-mono text-sm mb-2">${pokemon.code}</div>
            <div class="mb-2">HP: ${pokemon.hp} | ATK: ${pokemon.atk} | SPEED: ${pokemon.speed}</div>
            <div class="font-bold">${pokemon.rarity.toUpperCase()}</div>
          </div>
          
          <div class="flex gap-2">
            <button id="btn-release" class="flex-1 py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">Lepas Pokemon</button>
            <button id="btn-close" class="flex-1 py-2 rounded font-bold text-white" style="background-color: ${config.secondary_color}">Tutup</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('btn-release').onclick = async () => {
        if (useOfflineMode) {
          const index = allPokemonData.findIndex(p => p.__backendId === pokemon.__backendId);
          if (index !== -1) {
            allPokemonData.splice(index, 1);
            saveOfflineData();
            showToast(`${pokemon.name} telah dilepas`, 'info');
            modal.remove();
          }
        } else {
          const result = await window.dataSdk.delete(pokemon);
          if (result.isOk) {
            showToast(`${pokemon.name} telah dilepas`, 'info');
            modal.remove();
          }
        }
      };
      
      document.getElementById('btn-close').onclick = () => {
        modal.remove();
      };
    }

    let duelStoryStreak = 0;

    function renderDuelView() {
      currentView = 'duel';
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-2xl mx-auto">
          <button id="btn-back" class="mb-4 px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
          
          <h2 class="text-3xl font-bold mb-6 text-center" style="color: ${config.text_color}">Mode Duel</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="btn-pvp-duel" class="p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition" style="background-color: ${config.surface_color}">
              <div class="text-4xl mb-2">‚öîÔ∏è</div>
              <div class="text-xl font-bold mb-2" style="color: ${config.text_color}">Duel Pemain</div>
              <div class="text-sm" style="color: ${config.text_color}">Lawan teman dengan Pokemon koleksimu</div>
            </button>
            
            <button id="btn-story-duel" class="p-6 rounded-lg shadow-lg text-center hover:shadow-xl transition" style="background-color: ${config.surface_color}">
              <div class="text-4xl mb-2">üéÆ</div>
              <div class="text-xl font-bold mb-2" style="color: ${config.text_color}">Duel Story</div>
              <div class="text-sm" style="color: ${config.text_color}">Lawan Pokemon acak, menang beruntun dapat hadiah!</div>
              <div class="mt-2 font-bold" style="color: ${config.primary_color}">Streak: ${duelStoryStreak}</div>
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('btn-back').onclick = renderHome;
      document.getElementById('btn-pvp-duel').onclick = renderPvPDuel;
      document.getElementById('btn-story-duel').onclick = renderStoryDuel;
    }

    function renderPvPDuel() {
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-2xl mx-auto">
          <button id="btn-back" class="mb-4 px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
          
          <h2 class="text-3xl font-bold mb-6 text-center" style="color: ${config.text_color}">Duel Pemain</h2>
          
          <div class="p-6 rounded-lg shadow-lg mb-4" style="background-color: ${config.surface_color}">
            <label class="block mb-2 font-bold" style="color: ${config.text_color}">Kode Pokemon Kamu:</label>
            <input type="text" id="code1" placeholder="PKM-025-ABC123" class="w-full p-3 border-2 rounded mb-4" style="border-color: ${config.secondary_color}">
            
            <label class="block mb-2 font-bold" style="color: ${config.text_color}">Kode Pokemon Teman:</label>
            <input type="text" id="code2" placeholder="PKM-006-XYZ789" class="w-full p-3 border-2 rounded mb-4" style="border-color: ${config.secondary_color}">
            
            <button id="btn-duel" class="w-full py-3 rounded-lg font-bold text-white" style="background-color: ${config.primary_color}">Mulai Duel!</button>
          </div>
          
          <div id="duel-result" class="p-6 rounded-lg shadow-lg hidden" style="background-color: ${config.surface_color}"></div>
        </div>
      `;
      
      document.getElementById('btn-back').onclick = renderDuelView;
      
      document.getElementById('btn-duel').onclick = () => {
        const code1 = document.getElementById('code1').value.trim();
        const code2 = document.getElementById('code2').value.trim();
        
        const pokemon1 = allPokemonData.find(p => p.code === code1);
        
        if (!pokemon1) {
          showToast('Kode Pokemon kamu tidak ditemukan di koleksi!', 'error');
          return;
        }
        
        if (!code2) {
          showToast('Masukkan kode Pokemon teman!', 'error');
          return;
        }
        
        const codePattern = /^PKM-(\d{3})-([A-Z0-9]{6})$/;
        const match = code2.match(codePattern);
        
        if (!match) {
          showToast('Format kode Pokemon teman tidak valid!', 'error');
          return;
        }
        
        const pokemonId = parseInt(match[1]);
        
        fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonId}`)
          .then(response => response.json())
          .then(data => {
            const pokemon2 = {
              name: capitalizeFirst(data.name),
              image: data.sprites.front_default || data.sprites.other['official-artwork'].front_default,
              hp: data.stats[0].base_stat,
              atk: data.stats[1].base_stat,
              speed: data.stats[5].base_stat
            };
            
            const resultDiv = document.getElementById('duel-result');
            resultDiv.classList.remove('hidden');
            
            let winner, loser, isPlayer1Winner;
            
            if (pokemon1.speed > pokemon2.speed) {
              winner = pokemon1;
              loser = pokemon2;
              isPlayer1Winner = true;
            } else if (pokemon2.speed > pokemon1.speed) {
              winner = pokemon2;
              loser = pokemon1;
              isPlayer1Winner = false;
            } else {
              if (pokemon1.atk > pokemon2.atk) {
                winner = pokemon1;
                loser = pokemon2;
                isPlayer1Winner = true;
              } else {
                winner = pokemon2;
                loser = pokemon1;
                isPlayer1Winner = false;
              }
            }
            
            resultDiv.innerHTML = `
              <h3 class="text-2xl font-bold mb-4 text-center" style="color: ${config.text_color}">Hasil Duel</h3>
              
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center ${isPlayer1Winner ? 'ring-4 ring-yellow-400 rounded-lg p-2' : ''}">
                  <div class="text-sm font-bold mb-1" style="color: ${config.text_color}">Kamu</div>
                  <img src="${pokemon1.image}" alt="${pokemon1.name}" class="w-32 h-32 mx-auto mb-2">
                  <div class="font-bold" style="color: ${config.text_color}">${pokemon1.name}</div>
                  <div class="text-sm" style="color: ${config.text_color}">HP: ${pokemon1.hp} | ATK: ${pokemon1.atk} | SPD: ${pokemon1.speed}</div>
                </div>
                
                <div class="text-center ${!isPlayer1Winner ? 'ring-4 ring-yellow-400 rounded-lg p-2' : ''}">
                  <div class="text-sm font-bold mb-1" style="color: ${config.text_color}">Teman</div>
                  <img src="${pokemon2.image}" alt="${pokemon2.name}" class="w-32 h-32 mx-auto mb-2">
                  <div class="font-bold" style="color: ${config.text_color}">${pokemon2.name}</div>
                  <div class="text-sm" style="color: ${config.text_color}">HP: ${pokemon2.hp} | ATK: ${pokemon2.atk} | SPD: ${pokemon2.speed}</div>
                </div>
              </div>
              
              <div class="text-center p-4 rounded font-bold text-xl" style="background-color: ${config.primary_color}; color: white">
                üèÜ ${isPlayer1Winner ? 'KAMU MENANG!' : 'TEMAN MENANG!'} üèÜ
              </div>
            `;
          })
          .catch(error => {
            showToast('Gagal memuat data Pokemon teman!', 'error');
          });
      };
    }

    let selectedPokemonForDuel = null;

    function renderPokemonSelection() {
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-4xl mx-auto">
          <button id="btn-back" class="mb-4 px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
          
          <div class="text-center mb-6">
            <h2 class="text-3xl font-bold mb-2" style="color: ${config.text_color}">Pilih Pokemon untuk Duel</h2>
            <p style="color: ${config.text_color}">Klik Pokemon yang ingin kamu gunakan untuk bertarung</p>
          </div>
          
          <div id="pokemon-selection-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
      `;
      
      document.getElementById('btn-back').onclick = () => {
        selectedPokemonForDuel = null;
        renderDuelView();
      };
      
      const grid = document.getElementById('pokemon-selection-grid');
      
      allPokemonData.forEach(pokemon => {
        const card = document.createElement('div');
        card.className = 'pokemon-card p-4 rounded-lg shadow-lg cursor-pointer border-4 rarity-' + pokemon.rarity + ' hover:ring-4 hover:ring-yellow-400';
        card.style.backgroundColor = config.surface_color;
        
        card.innerHTML = `
          <img src="${pokemon.image}" alt="${pokemon.name}" class="w-full h-32 object-contain mb-2">
          <div class="text-center">
            <div class="font-bold text-lg" style="color: ${config.text_color}">${pokemon.name}</div>
            <div class="text-sm" style="color: ${config.text_color}">HP: ${pokemon.hp} | ATK: ${pokemon.atk} | SPD: ${pokemon.speed}</div>
            <div class="text-xs mt-1 font-bold" style="color: ${config.text_color}">${pokemon.rarity.toUpperCase()}</div>
          </div>
        `;
        
        card.onclick = () => {
          selectedPokemonForDuel = pokemon;
          showToast(`${pokemon.name} dipilih untuk bertarung!`, 'success');
          setTimeout(() => renderStoryDuel(), 500);
        };
        
        grid.appendChild(card);
      });
    }

    async function renderStoryDuel() {
      const config = window.elementSdk?.config || defaultConfig;
      
      if (allPokemonData.length === 0) {
        showToast('Kamu belum punya Pokemon! Jawab soal dulu.', 'error');
        renderDuelView();
        return;
      }
      
      // Jika belum memilih Pokemon, tampilkan layar pemilihan
      if (!selectedPokemonForDuel) {
        renderPokemonSelection();
        return;
      }
      
      const rarityByStreak = duelStoryStreak < 10 ? 'uncommon' :
                             duelStoryStreak < 20 ? 'common' :
                             duelStoryStreak < 30 ? 'rare' :
                             duelStoryStreak < 40 ? 'legendary' : 'mythical';
      
      const rarityRanges = {
        common: { hp: [20, 45], atk: [15, 40], speed: [15, 35] },
        uncommon: { hp: [40, 65], atk: [35, 60], speed: [30, 55] },
        rare: { hp: [60, 90], atk: [55, 80], speed: [50, 75] },
        legendary: { hp: [85, 120], atk: [75, 110], speed: [70, 100] },
        mythical: { hp: [100, 150], atk: [95, 135], speed: [85, 120] }
      };
      
      function randomStat(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }
      
      const randomId = Math.floor(Math.random() * 1010) + 1;
      
      try {
        const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`);
        const data = await response.json();
        
        const ranges = rarityRanges[rarityByStreak];
        const enemyPokemon = {
          name: capitalizeFirst(data.name),
          image: data.sprites.front_default || data.sprites.other['official-artwork'].front_default,
          hp: randomStat(ranges.hp[0], ranges.hp[1]),
          atk: randomStat(ranges.atk[0], ranges.atk[1]),
          speed: randomStat(ranges.speed[0], ranges.speed[1]),
          rarity: rarityByStreak
        };
        
        const myPokemon = selectedPokemonForDuel;
        
        document.getElementById('app').innerHTML = `
          <div class="max-w-2xl mx-auto">
            <div class="flex gap-2 mb-4">
              <button id="btn-back" class="px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
              <button id="btn-change-pokemon" class="px-4 py-2 rounded font-bold" style="background-color: ${config.primary_color}; color: white">üîÑ Ganti Pokemon</button>
            </div>
            
            <div class="text-center mb-4">
              <h2 class="text-3xl font-bold mb-2" style="color: ${config.text_color}">Duel Story</h2>
              <div class="text-xl font-bold" style="color: ${config.primary_color}">Streak: ${duelStoryStreak}</div>
              <div class="text-sm" style="color: ${config.text_color}">
                ${duelStoryStreak < 10 ? 'Menang 10x ‚Üí Uncommon Pokemon' :
                  duelStoryStreak < 20 ? 'Menang 20x ‚Üí Common Pokemon' :
                  duelStoryStreak < 30 ? 'Menang 30x ‚Üí Rare Pokemon' :
                  duelStoryStreak < 40 ? 'Menang 40x ‚Üí Legendary Pokemon' :
                  duelStoryStreak < 50 ? 'Menang 50x ‚Üí Mythical Pokemon' : 'MAX STREAK!'}
              </div>
            </div>
            
            <div class="p-6 rounded-lg shadow-lg mb-4" style="background-color: ${config.surface_color}">
              <h3 class="text-xl font-bold mb-4 text-center" style="color: ${config.text_color}">Pertarungan Dimulai!</h3>
              
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                  <div class="text-sm font-bold mb-1" style="color: ${config.text_color}">Pokemon Kamu</div>
                  <img src="${myPokemon.image}" alt="${myPokemon.name}" class="w-32 h-32 mx-auto mb-2">
                  <div class="font-bold" style="color: ${config.text_color}">${myPokemon.name}</div>
                  <div class="text-sm" style="color: ${config.text_color}">HP: ${myPokemon.hp} | ATK: ${myPokemon.atk} | SPD: ${myPokemon.speed}</div>
                </div>
                
                <div class="text-center">
                  <div class="text-sm font-bold mb-1" style="color: ${config.text_color}">Musuh (${rarityByStreak.toUpperCase()})</div>
                  <img src="${enemyPokemon.image}" alt="${enemyPokemon.name}" class="w-32 h-32 mx-auto mb-2">
                  <div class="font-bold" style="color: ${config.text_color}">${enemyPokemon.name}</div>
                  <div class="text-sm" style="color: ${config.text_color}">HP: ${enemyPokemon.hp} | ATK: ${enemyPokemon.atk} | SPD: ${enemyPokemon.speed}</div>
                </div>
              </div>
              
              <button id="btn-fight" class="w-full py-3 rounded-lg font-bold text-white" style="background-color: ${config.primary_color}">‚öîÔ∏è SERANG!</button>
            </div>
          </div>
        `;
        
        document.getElementById('btn-back').onclick = () => {
          duelStoryStreak = 0;
          selectedPokemonForDuel = null;
          renderDuelView();
        };
        
        document.getElementById('btn-change-pokemon').onclick = () => {
          selectedPokemonForDuel = null;
          renderStoryDuel();
        };
        
        document.getElementById('btn-fight').onclick = () => {
          let winner, isPlayerWinner;
          
          if (myPokemon.speed > enemyPokemon.speed) {
            winner = myPokemon;
            isPlayerWinner = true;
          } else if (enemyPokemon.speed > myPokemon.speed) {
            winner = enemyPokemon;
            isPlayerWinner = false;
          } else {
            if (myPokemon.atk > enemyPokemon.atk) {
              winner = myPokemon;
              isPlayerWinner = true;
            } else {
              winner = enemyPokemon;
              isPlayerWinner = false;
            }
          }
          
          if (isPlayerWinner) {
            duelStoryStreak++;
            
            let reward = null;
            if (duelStoryStreak === 10) reward = 'uncommon';
            else if (duelStoryStreak === 20) reward = 'common';
            else if (duelStoryStreak === 30) reward = 'rare';
            else if (duelStoryStreak === 40) reward = 'legendary';
            else if (duelStoryStreak === 50) reward = 'mythical';
            
            showToast(`üéâ MENANG! Streak: ${duelStoryStreak}`, 'success');
            
            if (reward) {
              setTimeout(() => {
                capturePokemon(reward);
                showToast(`üéÅ Hadiah ${reward.toUpperCase()} Pokemon!`, 'success');
              }, 1000);
            }
            
            setTimeout(() => renderStoryDuel(), 2000);
          } else {
            duelStoryStreak = 0;
            showToast('üíî KALAH! Streak direset ke 0', 'error');
            setTimeout(() => renderDuelView(), 2000);
          }
        };
        
      } catch (error) {
        showToast('Gagal memuat Pokemon musuh!', 'error');
        renderDuelView();
      }
    }

    function renderBackupView() {
      currentView = 'backup';
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-2xl mx-auto">
          <button id="btn-back" class="mb-4 px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
          
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.text_color}">Backup & Restore</h2>
          
          <div class="p-6 rounded-lg shadow-lg mb-4" style="background-color: ${config.surface_color}">
            <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}">Backup Data</h3>
            <button id="btn-backup-text" class="w-full mb-2 py-3 rounded-lg font-bold text-white" style="background-color: ${config.primary_color}">Buat Kode Backup</button>
            <button id="btn-backup-qr" class="w-full py-3 rounded-lg font-bold text-white" style="background-color: ${config.secondary_color}">Buat QR Code</button>
            <div id="backup-output" class="mt-4"></div>
          </div>
          
          <div class="p-6 rounded-lg shadow-lg" style="background-color: ${config.surface_color}">
            <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}">Restore Data</h3>
            <textarea id="restore-input" placeholder="Paste kode backup di sini..." class="w-full p-3 border-2 rounded mb-2 h-32" style="border-color: ${config.secondary_color}"></textarea>
            <button id="btn-restore" class="w-full mb-2 py-3 rounded-lg font-bold text-white" style="background-color: ${config.primary_color}">Restore dari Kode</button>
            <button id="btn-scan-qr" class="w-full py-3 rounded-lg font-bold text-white" style="background-color: ${config.secondary_color}">Scan QR Code</button>
            <div id="qr-reader" class="mt-4 hidden"></div>
          </div>
        </div>
      `;
      
      document.getElementById('btn-back').onclick = renderHome;
      
      document.getElementById('btn-backup-text').onclick = async () => {
        const backupData = {
          pokemon: allPokemonData,
          questions: questions,
          stats: stats
        };
        
        const compressed = LZString.compressToBase64(JSON.stringify(backupData));
        
        const output = document.getElementById('backup-output');
        output.innerHTML = `
          <textarea class="w-full p-3 border-2 rounded h-32" style="border-color: ${config.secondary_color}" readonly>${compressed}</textarea>
          <button id="btn-copy" class="w-full mt-2 py-2 rounded font-bold text-white" style="background-color: ${config.secondary_color}">Salin Kode</button>
        `;
        
        document.getElementById('btn-copy').onclick = () => {
          navigator.clipboard.writeText(compressed);
          showToast('Kode backup disalin!', 'success');
        };
      };
      
      document.getElementById('btn-backup-qr').onclick = async () => {
        const backupData = {
          pokemon: allPokemonData,
          questions: questions,
          stats: stats
        };
        
        const compressed = LZString.compressToBase64(JSON.stringify(backupData));
        
        const output = document.getElementById('backup-output');
        output.innerHTML = '<div class="flex justify-center"><canvas id="qr-canvas"></canvas></div>';
        
        try {
          await QRCode.toCanvas(document.getElementById('qr-canvas'), compressed, {
            width: 300,
            margin: 2,
            errorCorrectionLevel: 'L'
          });
          showToast('QR Code berhasil dibuat!', 'success');
        } catch (error) {
          showToast('Gagal membuat QR Code: Data terlalu besar', 'error');
        }
      };
      
      document.getElementById('btn-restore').onclick = async () => {
        const input = document.getElementById('restore-input').value.trim();
        
        if (!input) {
          showToast('Masukkan kode backup!', 'error');
          return;
        }
        
        try {
          const decompressed = LZString.decompressFromBase64(input);
          const backupData = JSON.parse(decompressed);
          
          if (useOfflineMode) {
            allPokemonData = backupData.pokemon;
            saveOfflineData();
          } else {
            for (const pokemon of allPokemonData) {
              await window.dataSdk.delete(pokemon);
            }
            
            for (const pokemon of backupData.pokemon) {
              await window.dataSdk.create(pokemon);
            }
          }
          
          questions = backupData.questions;
          stats = backupData.stats;
          saveLocalData();
          
          showToast('Data berhasil dipulihkan!', 'success');
          setTimeout(() => renderHome(), 1500);
        } catch (error) {
          showToast('Kode backup tidak valid!', 'error');
        }
      };
      
      document.getElementById('btn-scan-qr').onclick = () => {
        const readerDiv = document.getElementById('qr-reader');
        readerDiv.classList.remove('hidden');
        
        const html5QrCode = new Html5Qrcode("qr-reader");
        
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            html5QrCode.stop();
            
            try {
              const decompressed = LZString.decompressFromBase64(decodedText);
              const backupData = JSON.parse(decompressed);
              
              if (useOfflineMode) {
                allPokemonData = backupData.pokemon;
                saveOfflineData();
              } else {
                for (const pokemon of allPokemonData) {
                  await window.dataSdk.delete(pokemon);
                }
                
                for (const pokemon of backupData.pokemon) {
                  await window.dataSdk.create(pokemon);
                }
              }
              
              questions = backupData.questions;
              stats = backupData.stats;
              saveLocalData();
              
              showToast('Data berhasil dipulihkan dari QR!', 'success');
              setTimeout(() => renderHome(), 1500);
            } catch (error) {
              showToast('QR Code tidak valid!', 'error');
            }
          }
        );
      };
    }

    function renderSettingsView() {
      currentView = 'settings';
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-2xl mx-auto">
          <button id="btn-back" class="mb-4 px-4 py-2 rounded font-bold" style="background-color: ${config.secondary_color}; color: white">‚Üê Kembali</button>
          
          <h2 class="text-3xl font-bold mb-6" style="color: ${config.text_color}">Settings</h2>
          
          <div class="p-6 rounded-lg shadow-lg mb-4" style="background-color: ${config.surface_color}">
            <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}">Reset Data</h3>
            <p class="mb-4" style="color: ${config.text_color}">Hapus semua Pokemon dan reset statistik ke 0. Soal tidak akan terhapus.</p>
            
            <div class="bg-yellow-100 border-2 border-yellow-500 rounded p-4 mb-4">
              <p class="font-bold text-yellow-800">‚ö†Ô∏è Peringatan!</p>
              <p class="text-yellow-800">Tindakan ini tidak dapat dibatalkan. Semua Pokemon yang sudah ditangkap akan hilang.</p>
            </div>
            
            <button id="btn-reset" class="w-full py-3 rounded-lg font-bold text-white" style="background-color: ${config.primary_color}">Reset Semua Data</button>
          </div>
          
          <div class="p-6 rounded-lg shadow-lg" style="background-color: ${config.surface_color}">
            <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}">Informasi</h3>
            <div class="space-y-2" style="color: ${config.text_color}">
              <p><span class="font-bold">Total Pokemon Tersedia:</span> 1010 Pokemon</p>
              <p><span class="font-bold">Pokemon Tertangkap:</span> ${allPokemonData.length}</p>
              <p><span class="font-bold">Total Soal:</span> ${questions.length}</p>
              <p><span class="font-bold">Soal Dijawab:</span> ${stats.totalAnswered}</p>
              <p><span class="font-bold">Jawaban Benar:</span> ${stats.correctAnswers}</p>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('btn-back').onclick = renderHome;
      
      document.getElementById('btn-reset').onclick = () => {
        const confirmModal = document.createElement('div');
        confirmModal.className = 'fixed inset-0 flex items-center justify-center z-50';
        confirmModal.style.backgroundColor = 'rgba(0,0,0,0.8)';
        
        confirmModal.innerHTML = `
          <div class="rounded-lg p-6 max-w-md w-full mx-4" style="background-color: ${config.surface_color}">
            <h3 class="text-xl font-bold mb-4" style="color: ${config.text_color}">Konfirmasi Reset</h3>
            <p class="mb-6" style="color: ${config.text_color}">Apakah Anda yakin ingin menghapus semua Pokemon dan mereset statistik?</p>
            
            <div class="flex gap-2">
              <button id="confirm-reset" class="flex-1 py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">Ya, Reset</button>
              <button id="cancel-reset" class="flex-1 py-2 rounded font-bold text-white" style="background-color: ${config.secondary_color}">Batal</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(confirmModal);
        
        document.getElementById('confirm-reset').onclick = async () => {
          if (useOfflineMode) {
            allPokemonData = [];
            saveOfflineData();
          } else {
            for (const pokemon of allPokemonData) {
              await window.dataSdk.delete(pokemon);
            }
          }
          
          stats = {
            totalAnswered: 0,
            correctAnswers: 0,
            wrongStreak: 0,
            totalCaptured: 0
          };
          saveLocalData();
          
          confirmModal.remove();
          showToast('Semua data berhasil direset!', 'success');
          setTimeout(() => renderHome(), 1500);
        };
        
        document.getElementById('cancel-reset').onclick = () => {
          confirmModal.remove();
        };
      };
    }

    function openQuestionEditor() {
      const config = window.elementSdk?.config || defaultConfig;
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 overflow-y-auto z-50';
      modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
      
      modal.innerHTML = `
        <div class="min-h-full p-4">
          <div class="max-w-4xl mx-auto rounded-lg p-6" style="background-color: ${config.surface_color}">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold" style="color: ${config.text_color}">Editor Soal</h2>
              <button id="close-editor" class="px-4 py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">Tutup</button>
            </div>
            
            <div class="mb-6 p-4 rounded" style="background-color: ${config.background_color}">
              <h3 class="font-bold mb-2" style="color: ${config.text_color}">Tambah Soal Baru</h3>
              <input type="text" id="new-question" placeholder="Pertanyaan" class="w-full p-2 border rounded mb-2">
              <input type="text" id="new-answer" placeholder="Jawaban" class="w-full p-2 border rounded mb-2">
              <input type="text" id="new-topic" placeholder="Topik" class="w-full p-2 border rounded mb-2">
              <select id="new-difficulty" class="w-full p-2 border rounded mb-2">
                <option value="very_easy">Sangat Mudah (Common)</option>
                <option value="easy">Mudah (Uncommon)</option>
                <option value="medium">Sedang (Rare)</option>
                <option value="hard">Sulit (Legendary)</option>
                <option value="very_hard">Sangat Sulit (Mythical)</option>
              </select>
              <button id="add-question" class="w-full py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">Tambah Soal</button>
            </div>
            
            <div class="mb-4 space-y-2">
              <div class="flex gap-2">
                <button id="download-template" class="flex-1 py-2 rounded font-bold text-white" style="background-color: ${config.secondary_color}">üì• Download Template Excel</button>
                <button id="show-guide" class="flex-1 py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">üìñ Panduan</button>
              </div>
              <div class="flex gap-2">
                <label class="flex-1 py-2 rounded font-bold text-white text-center cursor-pointer" style="background-color: ${config.secondary_color}">
                  üì§ Import Excel/CSV
                  <input type="file" id="import-excel" accept=".xlsx,.xls,.csv" class="hidden">
                </label>
                <button id="export-excel" class="flex-1 py-2 rounded font-bold text-white" style="background-color: ${config.secondary_color}">üíæ Export Excel</button>
              </div>
              <button id="export-qr" class="w-full py-2 rounded font-bold text-white" style="background-color: ${config.secondary_color}">üì± Export QR Code</button>
            </div>
            
            <div id="questions-list" class="space-y-2"></div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      renderQuestionsList();
      
      document.getElementById('close-editor').onclick = () => {
        modal.remove();
      };
      
      document.getElementById('show-guide').onclick = () => {
        const guideModal = document.createElement('div');
        guideModal.className = 'fixed inset-0 overflow-y-auto z-50 p-4';
        guideModal.style.backgroundColor = 'rgba(0,0,0,0.9)';
        
        guideModal.innerHTML = `
          <div class="max-w-4xl mx-auto rounded-lg p-6" style="background-color: ${config.surface_color}">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold" style="color: ${config.text_color}">üìñ Panduan Lengkap Import/Export Excel</h2>
              <button id="close-guide" class="px-4 py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">Tutup</button>
            </div>
            
            <div class="space-y-6" style="color: ${config.text_color}">
              <div class="p-4 rounded" style="background-color: ${config.background_color}">
                <h3 class="text-xl font-bold mb-3">üéØ Cara Menggunakan Template Excel</h3>
                <ol class="list-decimal list-inside space-y-2">
                  <li><strong>Download Template</strong>: Klik tombol "üì• Download Template Excel"</li>
                  <li><strong>Buka File</strong>: Buka file Excel yang terdownload (Template_Soal_Pokemon.xlsx)</li>
                  <li><strong>Pilih Sheet</strong>: Gunakan sheet "Soal" (sudah ada contoh) atau "Template Kosong"</li>
                  <li><strong>Isi Data</strong>: Masukkan soal sesuai format kolom yang tersedia</li>
                  <li><strong>Simpan File</strong>: Save file Excel Anda</li>
                  <li><strong>Import</strong>: Klik "üì§ Import Excel/CSV" dan pilih file yang sudah diisi</li>
                </ol>
              </div>
              
              <div class="p-4 rounded" style="background-color: ${config.background_color}">
                <h3 class="text-xl font-bold mb-3">üìã Format Kolom Excel</h3>
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="border-b-2" style="border-color: ${config.secondary_color}">
                      <th class="text-left p-2">Kolom</th>
                      <th class="text-left p-2">Deskripsi</th>
                      <th class="text-left p-2">Contoh</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="border-b">
                      <td class="p-2 font-bold">Pertanyaan</td>
                      <td class="p-2">Teks soal yang akan ditampilkan</td>
                      <td class="p-2">Berapa hasil dari 2 + 2?</td>
                    </tr>
                    <tr class="border-b">
                      <td class="p-2 font-bold">Jawaban</td>
                      <td class="p-2">Jawaban yang benar (case insensitive)</td>
                      <td class="p-2">4</td>
                    </tr>
                    <tr class="border-b">
                      <td class="p-2 font-bold">Topik</td>
                      <td class="p-2">Kategori/mata pelajaran soal</td>
                      <td class="p-2">Matematika</td>
                    </tr>
                    <tr>
                      <td class="p-2 font-bold">Kesulitan</td>
                      <td class="p-2">Tingkat kesulitan (lihat tabel di bawah)</td>
                      <td class="p-2">very_easy</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="p-4 rounded" style="background-color: ${config.background_color}">
                <h3 class="text-xl font-bold mb-3">‚≠ê Tingkat Kesulitan & Rarity Pokemon</h3>
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="border-b-2" style="border-color: ${config.secondary_color}">
                      <th class="text-left p-2">Kode</th>
                      <th class="text-left p-2">Nama</th>
                      <th class="text-left p-2">Rarity Pokemon</th>
                      <th class="text-left p-2">Deskripsi</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="border-b">
                      <td class="p-2 font-mono">very_easy</td>
                      <td class="p-2">Sangat Mudah</td>
                      <td class="p-2">üîµ Common</td>
                      <td class="p-2">Soal dasar, mudah dijawab</td>
                    </tr>
                    <tr class="border-b">
                      <td class="p-2 font-mono">easy</td>
                      <td class="p-2">Mudah</td>
                      <td class="p-2">üü¢ Uncommon</td>
                      <td class="p-2">Soal sederhana dengan sedikit pemikiran</td>
                    </tr>
                    <tr class="border-b">
                      <td class="p-2 font-mono">medium</td>
                      <td class="p-2">Sedang</td>
                      <td class="p-2">üî∑ Rare</td>
                      <td class="p-2">Soal memerlukan pemahaman konsep</td>
                    </tr>
                    <tr class="border-b">
                      <td class="p-2 font-mono">hard</td>
                      <td class="p-2">Sulit</td>
                      <td class="p-2">üü£ Legendary</td>
                      <td class="p-2">Soal kompleks, butuh analisis</td>
                    </tr>
                    <tr>
                      <td class="p-2 font-mono">very_hard</td>
                      <td class="p-2">Sangat Sulit</td>
                      <td class="p-2">üü† Mythical</td>
                      <td class="p-2">Soal sangat menantang</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="p-4 rounded" style="background-color: ${config.background_color}">
                <h3 class="text-xl font-bold mb-3">üíæ Fitur Export Excel</h3>
                <p class="mb-2">Saat Anda export soal, file Excel akan berisi multiple sheets:</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                  <li><strong>Semua Soal</strong>: Berisi semua soal dengan lengkap</li>
                  <li><strong>Sangat Mudah - Sangat Sulit</strong>: Soal dikelompokkan per tingkat kesulitan</li>
                  <li><strong>Statistik</strong>: Ringkasan jumlah soal per topik dan kesulitan</li>
                </ul>
              </div>
              
              <div class="p-4 rounded" style="background-color: ${config.background_color}">
                <h3 class="text-xl font-bold mb-3">üí° Tips & Trik</h3>
                <ul class="list-disc list-inside space-y-1 ml-4">
                  <li>Gunakan topik yang konsisten untuk memudahkan filter soal</li>
                  <li>Buat variasi kesulitan agar gameplay lebih menarik</li>
                  <li>Jawaban tidak case-sensitive (huruf besar/kecil diabaikan)</li>
                  <li>Bisa import file CSV atau Excel (.xlsx, .xls)</li>
                  <li>Template sudah berisi contoh soal untuk referensi</li>
                  <li>Sheet "Referensi" berisi panduan lengkap tingkat kesulitan</li>
                </ul>
              </div>
              
              <div class="p-4 rounded bg-yellow-100 border-2 border-yellow-500">
                <h3 class="text-xl font-bold mb-2 text-yellow-800">‚ö†Ô∏è Perhatian</h3>
                <ul class="list-disc list-inside space-y-1 ml-4 text-yellow-800">
                  <li>Pastikan kolom "Kesulitan" diisi dengan kode yang benar (very_easy, easy, medium, hard, very_hard)</li>
                  <li>Jangan ubah nama kolom header (Pertanyaan, Jawaban, Topik, Kesulitan)</li>
                  <li>Baris kosong akan otomatis dilewati saat import</li>
                  <li>Import akan menambahkan soal baru, tidak menghapus soal lama</li>
                </ul>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(guideModal);
        
        document.getElementById('close-guide').onclick = () => {
          guideModal.remove();
        };
      };
      
      document.getElementById('add-question').onclick = () => {
        const question = document.getElementById('new-question').value.trim();
        const answer = document.getElementById('new-answer').value.trim();
        const topic = document.getElementById('new-topic').value.trim();
        const difficulty = document.getElementById('new-difficulty').value;
        
        const difficultyToRarity = {
          very_easy: 'common',
          easy: 'uncommon',
          medium: 'rare',
          hard: 'legendary',
          very_hard: 'mythical'
        };
        
        const rarity = difficultyToRarity[difficulty];
        
        if (!question || !answer || !topic) {
          showToast('Lengkapi semua field!', 'error');
          return;
        }
        
        questions.push({
          id: Date.now().toString(),
          question,
          answer,
          topic,
          difficulty,
          rarity
        });
        
        saveLocalData();
        renderQuestionsList();
        
        document.getElementById('new-question').value = '';
        document.getElementById('new-answer').value = '';
        document.getElementById('new-topic').value = '';
        
        showToast('Soal berhasil ditambahkan!', 'success');
      };
      
      document.getElementById('download-template').onclick = () => {
        const wb = XLSX.utils.book_new();
        
        // Sheet 1: Panduan
        const guideData = [
          ['PANDUAN PENGGUNAAN TEMPLATE SOAL POKEMON LEARNING QUEST'],
          [''],
          ['CARA MENGISI:'],
          ['1. Isi soal di sheet "Soal" dengan format yang sudah disediakan'],
          ['2. Kolom Kesulitan harus diisi dengan salah satu: very_easy, easy, medium, hard, very_hard'],
          ['3. Kesulitan menentukan rarity Pokemon yang didapat:'],
          ['   - very_easy = Common Pokemon'],
          ['   - easy = Uncommon Pokemon'],
          ['   - medium = Rare Pokemon'],
          ['   - hard = Legendary Pokemon'],
          ['   - very_hard = Mythical Pokemon'],
          ['4. Setelah selesai, simpan file dan import ke aplikasi'],
          [''],
          ['TIPS:'],
          ['- Gunakan topik yang sama untuk mengelompokkan soal'],
          ['- Buat variasi kesulitan agar lebih menantang'],
          ['- Jawaban harus exact match (huruf besar/kecil diabaikan)'],
          [''],
          ['CONTOH TOPIK:'],
          ['Matematika, IPA, IPS, Bahasa Indonesia, Bahasa Inggris, Sejarah, dll']
        ];
        const wsGuide = XLSX.utils.aoa_to_sheet(guideData);
        wsGuide['!cols'] = [{ wch: 80 }];
        XLSX.utils.book_append_sheet(wb, wsGuide, 'Panduan');
        
        // Sheet 2: Soal (dengan contoh)
        const soalData = [
          ['Pertanyaan', 'Jawaban', 'Topik', 'Kesulitan'],
          ['Berapa hasil dari 2 + 2?', '4', 'Matematika', 'very_easy'],
          ['Berapa hasil dari 5 + 3?', '8', 'Matematika', 'easy'],
          ['Berapa hasil dari 12 x 5?', '60', 'Matematika', 'medium'],
          ['Berapa akar kuadrat dari 144?', '12', 'Matematika', 'hard'],
          ['Selesaikan persamaan: 2x¬≤ + 5x - 3 = 0', 'x=0.5 atau x=-3', 'Matematika', 'very_hard'],
          ['Apa ibu kota Indonesia?', 'Jakarta', 'Geografi', 'very_easy'],
          ['Siapa presiden pertama Indonesia?', 'Soekarno', 'Sejarah', 'easy'],
          ['Apa rumus kimia air?', 'H2O', 'IPA', 'easy'],
          ['Berapa jumlah planet di tata surya?', '8', 'IPA', 'medium'],
          ['Apa nama proses fotosintesis pada tumbuhan?', 'Fotosintesis', 'IPA', 'medium']
        ];
        const wsSoal = XLSX.utils.aoa_to_sheet(soalData);
        wsSoal['!cols'] = [{ wch: 50 }, { wch: 20 }, { wch: 20 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, wsSoal, 'Soal');
        
        // Sheet 3: Referensi Kesulitan
        const refData = [
          ['Tingkat Kesulitan', 'Kode', 'Rarity Pokemon', 'Deskripsi'],
          ['Sangat Mudah', 'very_easy', 'Common', 'Soal dasar, mudah dijawab'],
          ['Mudah', 'easy', 'Uncommon', 'Soal sederhana dengan sedikit pemikiran'],
          ['Sedang', 'medium', 'Rare', 'Soal memerlukan pemahaman konsep'],
          ['Sulit', 'hard', 'Legendary', 'Soal kompleks, butuh analisis'],
          ['Sangat Sulit', 'very_hard', 'Mythical', 'Soal sangat menantang']
        ];
        const wsRef = XLSX.utils.aoa_to_sheet(refData);
        wsRef['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 20 }, { wch: 40 }];
        XLSX.utils.book_append_sheet(wb, wsRef, 'Referensi');
        
        // Sheet 4: Template Kosong
        const templateData = [
          ['Pertanyaan', 'Jawaban', 'Topik', 'Kesulitan'],
          ['', '', '', 'very_easy'],
          ['', '', '', 'easy'],
          ['', '', '', 'medium'],
          ['', '', '', 'hard'],
          ['', '', '', 'very_hard']
        ];
        const wsTemplate = XLSX.utils.aoa_to_sheet(templateData);
        wsTemplate['!cols'] = [{ wch: 50 }, { wch: 20 }, { wch: 20 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, wsTemplate, 'Template Kosong');
        
        XLSX.writeFile(wb, 'Template_Soal_Pokemon.xlsx');
        showToast('Template Excel berhasil diunduh!', 'success');
      };
      
      document.getElementById('import-excel').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            const difficultyToRarity = {
              very_easy: 'common',
              easy: 'uncommon',
              medium: 'rare',
              hard: 'legendary',
              very_hard: 'mythical'
            };
            
            let importedCount = 0;
            let sheetName = '';
            
            // Cari sheet yang berisi soal (prioritas: Soal, Template Kosong, atau sheet pertama)
            if (workbook.SheetNames.includes('Soal')) {
              sheetName = 'Soal';
            } else if (workbook.SheetNames.includes('Template Kosong')) {
              sheetName = 'Template Kosong';
            } else {
              sheetName = workbook.SheetNames[0];
            }
            
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Skip header row (index 0)
            for (let i = 1; i < jsonData.length; i++) {
              const row = jsonData[i];
              
              // Skip empty rows
              if (!row || row.length === 0 || !row[0]) continue;
              
              const question = String(row[0] || '').trim();
              const answer = String(row[1] || '').trim();
              const topic = String(row[2] || '').trim();
              const difficulty = String(row[3] || 'very_easy').trim();
              
              if (question && answer && topic) {
                const rarity = difficultyToRarity[difficulty] || 'common';
                
                questions.push({
                  id: Date.now().toString() + '_' + i + '_' + Math.random().toString(36).substr(2, 5),
                  question: question,
                  answer: answer,
                  topic: topic,
                  difficulty: difficulty,
                  rarity: rarity
                });
                
                importedCount++;
              }
            }
            
            saveLocalData();
            renderQuestionsList();
            showToast(`Berhasil import ${importedCount} soal dari sheet "${sheetName}"!`, 'success');
          } catch (error) {
            console.error('Import error:', error);
            showToast('Gagal import file: ' + error.message, 'error');
          }
        };
        
        reader.readAsArrayBuffer(file);
      };
      
      document.getElementById('export-excel').onclick = () => {
        if (questions.length === 0) {
          showToast('Belum ada soal untuk di-export!', 'error');
          return;
        }
        
        const wb = XLSX.utils.book_new();
        
        // Sheet 1: Semua Soal
        const allQuestionsData = [
          ['Pertanyaan', 'Jawaban', 'Topik', 'Kesulitan', 'Rarity']
        ];
        
        questions.forEach(q => {
          allQuestionsData.push([
            q.question,
            q.answer,
            q.topic,
            q.difficulty,
            q.rarity
          ]);
        });
        
        const wsAll = XLSX.utils.aoa_to_sheet(allQuestionsData);
        wsAll['!cols'] = [{ wch: 50 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, wsAll, 'Semua Soal');
        
        // Sheet 2-6: Soal per Kesulitan
        const difficulties = ['very_easy', 'easy', 'medium', 'hard', 'very_hard'];
        const difficultyNames = {
          very_easy: 'Sangat Mudah',
          easy: 'Mudah',
          medium: 'Sedang',
          hard: 'Sulit',
          very_hard: 'Sangat Sulit'
        };
        
        difficulties.forEach(diff => {
          const filteredQuestions = questions.filter(q => q.difficulty === diff);
          
          if (filteredQuestions.length > 0) {
            const diffData = [
              ['Pertanyaan', 'Jawaban', 'Topik']
            ];
            
            filteredQuestions.forEach(q => {
              diffData.push([q.question, q.answer, q.topic]);
            });
            
            const wsDiff = XLSX.utils.aoa_to_sheet(diffData);
            wsDiff['!cols'] = [{ wch: 50 }, { wch: 20 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, wsDiff, difficultyNames[diff]);
          }
        });
        
        // Sheet 7: Statistik per Topik
        const topicStats = {};
        questions.forEach(q => {
          if (!topicStats[q.topic]) {
            topicStats[q.topic] = {
              very_easy: 0,
              easy: 0,
              medium: 0,
              hard: 0,
              very_hard: 0,
              total: 0
            };
          }
          topicStats[q.topic][q.difficulty]++;
          topicStats[q.topic].total++;
        });
        
        const statsData = [
          ['Topik', 'Sangat Mudah', 'Mudah', 'Sedang', 'Sulit', 'Sangat Sulit', 'Total']
        ];
        
        Object.keys(topicStats).forEach(topic => {
          const stats = topicStats[topic];
          statsData.push([
            topic,
            stats.very_easy,
            stats.easy,
            stats.medium,
            stats.hard,
            stats.very_hard,
            stats.total
          ]);
        });
        
        const wsStats = XLSX.utils.aoa_to_sheet(statsData);
        wsStats['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, wsStats, 'Statistik');
        
        const timestamp = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `Soal_Pokemon_${timestamp}.xlsx`);
        showToast(`Berhasil export ${questions.length} soal ke Excel!`, 'success');
      };
      
      document.getElementById('export-qr').onclick = async () => {
        const compressed = LZString.compressToBase64(JSON.stringify(questions));
        
        const qrModal = document.createElement('div');
        qrModal.className = 'fixed inset-0 flex items-center justify-center z-50 p-4 overflow-y-auto';
        qrModal.style.backgroundColor = 'rgba(0,0,0,0.9)';
        
        const maxQRSize = 2000;
        
        if (compressed.length > maxQRSize) {
          const chunkSize = Math.ceil(compressed.length / Math.ceil(compressed.length / maxQRSize));
          const totalChunks = Math.ceil(compressed.length / chunkSize);
          
          let qrHTML = `
            <div class="p-6 rounded max-w-4xl w-full" style="background-color: ${config.surface_color}">
              <h3 class="text-xl font-bold mb-4 text-center" style="color: ${config.text_color}">QR Code Soal (${totalChunks} bagian)</h3>
              <p class="text-center mb-4" style="color: ${config.text_color}">Scan semua QR code secara berurutan</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          `;
          
          for (let i = 0; i < totalChunks; i++) {
            const chunk = compressed.slice(i * chunkSize, (i + 1) * chunkSize);
            const chunkData = JSON.stringify({
              part: i + 1,
              total: totalChunks,
              data: chunk
            });
            
            qrHTML += `
              <div class="text-center p-4 border-2 rounded" style="border-color: ${config.secondary_color}">
                <div class="font-bold mb-2" style="color: ${config.text_color}">Bagian ${i + 1}/${totalChunks}</div>
                <canvas id="qr-canvas-${i}" class="mx-auto"></canvas>
              </div>
            `;
          }
          
          qrHTML += `
              </div>
              <button id="close-qr" class="w-full py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">Tutup</button>
            </div>
          `;
          
          qrModal.innerHTML = qrHTML;
          document.body.appendChild(qrModal);
          
          for (let i = 0; i < totalChunks; i++) {
            const chunk = compressed.slice(i * chunkSize, (i + 1) * chunkSize);
            const chunkData = JSON.stringify({
              part: i + 1,
              total: totalChunks,
              data: chunk
            });
            
            try {
              await QRCode.toCanvas(document.getElementById(`qr-canvas-${i}`), chunkData, {
                width: 200,
                margin: 1,
                errorCorrectionLevel: 'L'
              });
            } catch (error) {
              console.error(`Failed to generate QR ${i + 1}:`, error);
            }
          }
        } else {
          qrModal.innerHTML = `
            <div class="p-6 rounded max-w-md w-full" style="background-color: ${config.surface_color}">
              <h3 class="text-xl font-bold mb-4 text-center" style="color: ${config.text_color}">QR Code Soal</h3>
              <div class="flex justify-center mb-4">
                <canvas id="export-qr-canvas"></canvas>
              </div>
              <div class="text-center mb-4">
                <button id="copy-code-btn" class="px-4 py-2 rounded font-bold text-white" style="background-color: ${config.secondary_color}">Salin Kode</button>
              </div>
              <button id="close-qr" class="w-full py-2 rounded font-bold text-white" style="background-color: ${config.primary_color}">Tutup</button>
            </div>
          `;
          
          document.body.appendChild(qrModal);
          
          try {
            await QRCode.toCanvas(document.getElementById('export-qr-canvas'), compressed, {
              width: 300,
              margin: 2,
              errorCorrectionLevel: 'L'
            });
            
            document.getElementById('copy-code-btn').onclick = () => {
              navigator.clipboard.writeText(compressed);
              showToast('Kode berhasil disalin!', 'success');
            };
          } catch (error) {
            showToast('Gagal membuat QR Code', 'error');
          }
        }
        
        document.getElementById('close-qr').onclick = () => {
          qrModal.remove();
        };
      };
      
      function renderQuestionsList() {
        const list = document.getElementById('questions-list');
        list.innerHTML = '';
        
        questions.forEach((q, index) => {
          const item = document.createElement('div');
          item.className = 'p-3 rounded border-2';
          item.style.borderColor = config.secondary_color;
          
          item.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="font-bold" style="color: ${config.text_color}">${q.question}</div>
                <div class="text-sm" style="color: ${config.text_color}">Jawaban: ${q.answer} | ${q.topic} | ${q.difficulty} | ${q.rarity}</div>
              </div>
              <button class="ml-2 px-3 py-1 rounded font-bold text-white" style="background-color: ${config.primary_color}" onclick="deleteQuestion(${index})">Hapus</button>
            </div>
          `;
          
          list.appendChild(item);
        });
      }
      
      window.deleteQuestion = (index) => {
        questions.splice(index, 1);
        saveLocalData();
        renderQuestionsList();
        showToast('Soal dihapus', 'info');
      };
    }

    async function onConfigChange(config) {
      document.documentElement.style.setProperty('--primary-color', config.primary_color || defaultConfig.primary_color);
      document.documentElement.style.setProperty('--secondary-color', config.secondary_color || defaultConfig.secondary_color);
      document.documentElement.style.setProperty('--text-color', config.text_color || defaultConfig.text_color);
      document.documentElement.style.setProperty('--background-color', config.background_color || defaultConfig.background_color);
      document.documentElement.style.setProperty('--surface-color', config.surface_color || defaultConfig.surface_color);
      
      if (currentView === 'home') {
        renderHome();
      } else if (currentView === 'quiz') {
        renderQuizView();
      } else if (currentView === 'collection') {
        renderCollectionView();
      } else if (currentView === 'duel') {
        renderDuelView();
      } else if (currentView === 'backup') {
        renderBackupView();
      } else if (currentView === 'settings') {
        renderSettingsView();
      }
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["game_title", config.game_title || defaultConfig.game_title],
          ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
          ["menu_quiz", config.menu_quiz || defaultConfig.menu_quiz],
          ["menu_collection", config.menu_collection || defaultConfig.menu_collection],
          ["menu_duel", config.menu_duel || defaultConfig.menu_duel],
          ["menu_backup", config.menu_backup || defaultConfig.menu_backup]
        ])
      });
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99d71ff7e296c5f0',t:'MTc2Mjk2MTk5Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>