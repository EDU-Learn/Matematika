<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <title>Pokemon Learning Quest v3.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script><!-- Canva SDKs (optional, will fallback to localStorage if not available) -->
  <script src="/_sdk/element_sdk.js" onerror="console.log('Element SDK not available, using defaults')"></script>
  <script src="/_sdk/data_sdk.js" onerror="console.log('Data SDK not available, using localStorage')"></script><!-- External Libraries --> <!-- LZ-String for compression -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script><!-- html5-qrcode for QR scan -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script><!-- qrcode.js for QR generate -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><!-- SheetJS / XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    /* Pokeball button base */
    .pokeball-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 5px solid #000000;
      position: relative;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s ease;
      background: linear-gradient(
        180deg,
        #ef4444 0%,
        #ef4444 48%,
        #000000 48%,
        #000000 52%,
        #ffffff 52%,
        #ffffff 100%
      );
    }
    .pokeball-btn::before {
      content: "";
      position: absolute;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background-color: #ffffff;
      border: 4px solid #000000;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }
    .pokeball-btn::after {
      content: "";
      position: absolute;
      height: 5px;
      width: 100%;
      background-color: #000000;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      z-index: 1;
    }
    .pokeball-btn:hover {
      transform: scale(1.1);
    }

    /* Pokemon card hover */
    .pokemon-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .pokemon-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.25);
    }

    /* Toast animation */
    @keyframes slideInToast {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .toast {
      animation: slideInToast 0.3s ease-out;
    }

    /* Capture animation: simple scale + glow */
    @keyframes capturePulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239,68,68,0.7); }
      50% { transform: scale(1.1); box-shadow: 0 0 20px 8px rgba(239,68,68,0.7); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239,68,68,0.0); }
    }
    .capture-anim {
      animation: capturePulse 0.6s ease-out;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app-root" class="h-full flex flex-col"></div>
  <script>
    // -------- CONFIG & ELEMENT SDK --------
    const defaultConfig = {
      background_color: "#f0f9ff",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      primary_color: "#ef4444",
      secondary_color: "#3b82f6",
      game_title: "Pokemon Learning Quest v3.0",
      welcome_message: "Latih kemampuan rasio dengan Pokemon!",
      menu_quiz: "Soal",
      menu_collection: "Koleksi",
      menu_duel: "Duel",
      menu_backup: "Backup"
    };

    // Globals from config-refreshed values
    let currentConfig = { ...defaultConfig };

    // DOM refs for config-driven elements
    const domRefs = {
      root: null,
      title: null,
      subtitle: null,
      menuLabels: {},
      mainWrapper: null
    };

    // -------- DATA STORAGE (SDK or localStorage fallback) --------
    let dataInitialized = false;
    let allPokemonRecords = []; // latest data from sheet or localStorage
    let currentRecordCount = 0;
    let useLocalStorageMode = false; // true when SDK not available

    const LS_POKEMON_KEY = "plq_pokemon_v3";

    const rarityOrder = ["common", "uncommon", "rare", "legendary", "mythical"];

    // Rarity border colors (fixed, not recolorables)
    const rarityColors = {
      common: "#9ca3af",
      uncommon: "#10b981",
      rare: "#3b82f6",
      legendary: "#a855f7",
      mythical: "#f59e0b"
    };

    // -------- LOCAL STORAGE KEYS (for quiz & stats) --------
    const LS_KEYS = {
      STATS: "plq_stats_v3",
      SETTINGS: "plq_settings_v3",
      BACKUP_TEXT: "plq_backup_text_v3"
    };

    const defaultStats = {
      questionsAnswered: 0,
      correctAnswers: 0,
      currentWrongStreak: 0,
      totalReleased: 0
    };

    let appStats = { ...defaultStats };

    const defaultSettings = {
      offlineMode: false
    };
    let appSettings = { ...defaultSettings };

    function loadLocalStats() {
      try {
        const s = window.localStorage.getItem(LS_KEYS.STATS);
        if (s) {
          appStats = { ...defaultStats, ...JSON.parse(s) };
        }
      } catch(e){}
    }
    function saveLocalStats() {
      try {
        window.localStorage.setItem(LS_KEYS.STATS, JSON.stringify(appStats));
      } catch(e){}
    }
    function loadLocalSettings() {
      try {
        const s = window.localStorage.getItem(LS_KEYS.SETTINGS);
        if (s) {
          appSettings = { ...defaultSettings, ...JSON.parse(s) };
        }
      } catch(e){}
    }
    function saveLocalSettings() {
      try {
        window.localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(appSettings));
      } catch(e){}
    }

    // -------- LOCALSTORAGE POKEMON MANAGEMENT --------
    function loadPokemonFromLocalStorage() {
      try {
        const data = window.localStorage.getItem(LS_POKEMON_KEY);
        if (data) {
          allPokemonRecords = JSON.parse(data);
          currentRecordCount = allPokemonRecords.length;
        }
      } catch(e) {
        allPokemonRecords = [];
        currentRecordCount = 0;
      }
    }

    function savePokemonToLocalStorage() {
      try {
        window.localStorage.setItem(LS_POKEMON_KEY, JSON.stringify(allPokemonRecords));
        currentRecordCount = allPokemonRecords.length;
      } catch(e) {}
    }

    function createPokemonLocalStorage(record) {
      if (currentRecordCount >= 999) {
        return { isOk: false, error: new Error("Limit reached") };
      }
      // Add unique ID for localStorage mode
      record.__backendId = `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      allPokemonRecords.push(record);
      savePokemonToLocalStorage();
      updateCollectionUI();
      return { isOk: true };
    }

    function deletePokemonLocalStorage(record) {
      const index = allPokemonRecords.findIndex(r => r.__backendId === record.__backendId);
      if (index !== -1) {
        allPokemonRecords.splice(index, 1);
        savePokemonToLocalStorage();
        updateCollectionUI();
        return { isOk: true };
      }
      return { isOk: false, error: new Error("Not found") };
    }

    function updateCollectionUI() {
      const collectionContainer = document.getElementById("collection-list");
      if (collectionContainer) {
        renderCollectionListInto(collectionContainer);
      }
      updateStatsText();
    }

    // -------- TOAST SYSTEM --------
    function showToast(message, type = "info") {
      // type: success | error | info
      const containerId = "toast-container";
      let container = document.getElementById(containerId);
      if (!container) {
        container = document.createElement("div");
        container.id = containerId;
        container.className = "fixed top-20 right-20 z-50 space-y-2";
        document.body.appendChild(container);
      }

      const toast = document.createElement("div");
      let bgColor = "bg-blue-500";
      if (type === "success") bgColor = "bg-green-500";
      if (type === "error") bgColor = "bg-red-500";
      toast.className = `toast text-white font-bold px-6 py-4 rounded-lg shadow-lg ${bgColor}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
        if (!container.hasChildNodes()) container.remove();
      }, 3000);
    }

    // -------- HELPER: Unique Pokemon Code --------
    function generatePokemonCode() {
      const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const digits = "0123456789";
      let prefix = "";
      for (let i = 0; i < 3; i++) {
        prefix += letters[Math.floor(Math.random() * letters.length)];
      }
      let suffix = "";
      for (let i = 0; i < 6; i++) {
        suffix += digits[Math.floor(Math.random() * digits.length)];
      }
      return `PKM-${prefix}-${suffix}`;
    }

    // -------- HELPER: Rarity & Stats Scaling --------
    function getRarityByDifficulty(diff) {
      switch(diff) {
        case "very_easy": return "common";
        case "easy": return "uncommon";
        case "medium": return "rare";
        case "hard": return "legendary";
        case "very_hard": return "mythical";
        default: return "common";
      }
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function scaleStats(base, rarity) {
      const multipliers = {
        common: 1.0,
        uncommon: 1.1,
        rare: 1.25,
        legendary: 1.5,
        mythical: 1.8
      };
      const m = multipliers[rarity] || 1.0;
      return Math.round(base * m);
    }

    // -------- PokeAPI Fetch (with offline fallback) --------
    async function fetchRandomPokemon(rarity) {
      // If offline mode, generate dummy
      if (appSettings.offlineMode) {
        const id = randomInt(1, 898);
        const baseHp = randomInt(35, 110);
        const baseAtk = randomInt(40, 130);
        const baseSpd = randomInt(30, 130);
        return {
          name: `offline-mon-${id}`,
          sprite: "",
          rarity,
          hp: scaleStats(baseHp, rarity),
          atk: scaleStats(baseAtk, rarity),
          speed: scaleStats(baseSpd, rarity)
        };
      }

      try {
        const id = randomInt(1, 898);
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
        if (!res.ok) throw new Error("PokeAPI error");
        const data = await res.json();
        const hp = data.stats.find(s => s.stat.name === "hp")?.base_stat || 50;
        const atk = data.stats.find(s => s.stat.name === "attack")?.base_stat || 50;
        const spd = data.stats.find(s => s.stat.name === "speed")?.base_stat || 50;
        return {
          name: data.name,
          sprite: data.sprites?.front_default || "",
          rarity,
          hp: scaleStats(hp, rarity),
          atk: scaleStats(atk, rarity),
          speed: scaleStats(spd, rarity)
        };
      } catch(e) {
        // fallback dummy
        const baseHp = randomInt(35, 110);
        const baseAtk = randomInt(40, 130);
        const baseSpd = randomInt(30, 130);
        return {
          name: "fallback-mon",
          sprite: "",
          rarity,
          hp: scaleStats(baseHp, rarity),
          atk: scaleStats(baseAtk, rarity),
          speed: scaleStats(baseSpd, rarity)
        };
      }
    }

    // -------- DATA SDK HANDLER --------
    const dataHandler = {
      onDataChanged(data) {
        // Keep local cache and update UI selectively
        allPokemonRecords = data;
        currentRecordCount = data.length;

        // Update collection view if active
        const collectionContainer = document.getElementById("collection-list");
        if (collectionContainer) {
          renderCollectionListInto(collectionContainer);
        }

        // Update header stats if visible
        updateStatsText();
      }
    };

    async function initDataSdk() {
      if (!window.dataSdk) {
        // Fallback to localStorage mode
        useLocalStorageMode = true;
        loadPokemonFromLocalStorage();
        dataInitialized = true;
        showToast("Mode Browser: Data disimpan di localStorage", "info");
        return true;
      }
      if (dataInitialized) {
        return true;
      }
      
      try {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          // Fallback to localStorage
          useLocalStorageMode = true;
          loadPokemonFromLocalStorage();
          dataInitialized = true;
          showToast("Mode Browser: Data disimpan di localStorage", "info");
          return true;
        }
        dataInitialized = true;
        useLocalStorageMode = false;
        showToast("Mode Canva: Data disimpan di Canva Sheet", "success");
        return true;
      } catch(e) {
        // Fallback to localStorage
        useLocalStorageMode = true;
        loadPokemonFromLocalStorage();
        dataInitialized = true;
        showToast("Mode Browser: Data disimpan di localStorage", "info");
        return true;
      }
    }

    // -------- STATS LABEL UPDATE --------
    function updateStatsText() {
      const el = document.getElementById("stats-text");
      if (!el) return;
      const pokemonCount = allPokemonRecords.length;
      el.textContent = `Soal Dijawab: ${appStats.questionsAnswered} | Benar: ${appStats.correctAnswers} | Pokemon: ${pokemonCount}`;
    }

    // -------- MAIN APP RENDERING --------
    function createBaseLayout() {
      const root = document.getElementById("app-root");
      root.innerHTML = "";
      domRefs.root = root;

      const mainWrapper = document.createElement("div");
      mainWrapper.id = "main-wrapper";
      mainWrapper.className = "flex-1 flex flex-col items-center";
      domRefs.mainWrapper = mainWrapper;

      root.appendChild(mainWrapper);
      renderHomeScreen();
    }

    function applyTheme(config) {
      const bg = config.background_color || defaultConfig.background_color;
      const surface = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primary = config.primary_color || defaultConfig.primary_color;
      const secondary = config.secondary_color || defaultConfig.secondary_color;

      // Body background
      document.body.style.backgroundColor = bg;
      document.body.style.color = textColor;

      // Surface elements
      const surfaces = document.querySelectorAll(".surface-card");
      surfaces.forEach(el => {
        el.style.backgroundColor = surface;
      });

      // Text elements
      const textEls = document.querySelectorAll(".text-main");
      textEls.forEach(el => {
        el.style.color = textColor;
      });

      // Primary buttons
      const primaryEls = document.querySelectorAll(".btn-primary");
      primaryEls.forEach(el => {
        el.style.backgroundColor = primary;
        el.style.borderColor = primary;
        el.style.color = "#ffffff";
      });

      // Secondary buttons / accents
      const secondaryEls = document.querySelectorAll(".btn-secondary, .accent-secondary-border");
      secondaryEls.forEach(el => {
        el.style.borderColor = secondary;
        if (el.classList.contains("btn-secondary")) {
          el.style.color = secondary;
        }
      });
    }

    function applyTypography(config) {
      const baseSize = (config.font_size || defaultConfig.font_size || 16);
      const fontFamily = (config.font_family || defaultConfig.font_family || "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif");

      const titleEl = document.getElementById("app-title");
      const subtitleEl = document.getElementById("app-subtitle");
      if (titleEl) {
        titleEl.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
        titleEl.style.fontSize = (baseSize * 2) + "px";
      }
      if (subtitleEl) {
        subtitleEl.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
        subtitleEl.style.fontSize = (baseSize * 1.1) + "px";
      }

      const bodyTextEls = document.querySelectorAll(".body-text");
      bodyTextEls.forEach(el => {
        el.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
        el.style.fontSize = baseSize + "px";
      });

      const labelEls = document.querySelectorAll(".label-text");
      labelEls.forEach(el => {
        el.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
        el.style.fontSize = (baseSize * 0.9) + "px";
      });

      const smallEls = document.querySelectorAll(".caption-text");
      smallEls.forEach(el => {
        el.style.fontFamily = `${fontFamily}, system-ui, sans-serif`;
        el.style.fontSize = (baseSize * 0.8) + "px";
      });
    }

    function renderHomeScreen() {
      const main = domRefs.mainWrapper;
      if (!main) return;
      main.innerHTML = "";

      const container = document.createElement("main");
      container.className = "flex-1 w-full flex flex-col items-center";
      container.setAttribute("role", "main");

      const inner = document.createElement("div");
      inner.className = "max-w-4xl w-full mx-auto px-4 py-6";

      // Header
      const header = document.createElement("header");
      header.className = "mb-6";
      header.setAttribute("role", "banner");

      const h1 = document.createElement("h1");
      h1.id = "app-title";
      h1.className = "text-4xl font-bold mb-2 text-main body-text";
      h1.textContent = currentConfig.game_title || defaultConfig.game_title;
      domRefs.title = h1;

      const p = document.createElement("p");
      p.id = "app-subtitle";
      p.className = "text-lg text-main body-text";
      p.textContent = currentConfig.welcome_message || defaultConfig.welcome_message;
      domRefs.subtitle = p;

      header.appendChild(h1);
      header.appendChild(p);

      // Stats
      const statsCard = document.createElement("section");
      statsCard.className = "surface-card rounded-lg p-4 mb-6 shadow body-text";
      statsCard.setAttribute("aria-label", "Statistik");
      const statsP = document.createElement("p");
      statsP.id = "stats-text";
      statsP.className = "text-main";
      statsCard.appendChild(statsP);

      // Menu grid
      const nav = document.createElement("nav");
      nav.className = "mt-4";
      nav.setAttribute("aria-label", "Menu utama");
      const grid = document.createElement("div");
      grid.className = "grid grid-cols-2 md:grid-cols-5 gap-6";

      const menus = [
        { key: "quiz", labelKey: "menu_quiz", defaultLabel: "Soal", handler: () => openQuizScreen() },
        { key: "collection", labelKey: "menu_collection", defaultLabel: "Koleksi", handler: () => openCollectionScreen() },
        { key: "duel", labelKey: "menu_duel", defaultLabel: "Duel", handler: () => openDuelScreen() },
        { key: "backup", labelKey: "menu_backup", defaultLabel: "Backup", handler: () => openBackupScreen() },
        { key: "settings", labelKey: null, defaultLabel: "Settings", handler: () => openSettingsScreen() }
      ];

      menus.forEach(m => {
        const wrapper = document.createElement("button");
        wrapper.type = "button";
        wrapper.className = "flex flex-col items-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500";
        wrapper.addEventListener("click", (e) => {
          e.preventDefault();
          m.handler();
        });

        const ball = document.createElement("div");
        ball.className = "pokeball-btn mb-3";

        const label = document.createElement("span");
        label.className = "mt-1 text-center text-main body-text";
        const text = m.labelKey ? (currentConfig[m.labelKey] || defaultConfig[m.labelKey]) : m.defaultLabel;
        label.textContent = text;
        domRefs.menuLabels[m.key] = label;

        wrapper.appendChild(ball);
        wrapper.appendChild(label);
        grid.appendChild(wrapper);
      });

      nav.appendChild(grid);

      inner.appendChild(header);
      inner.appendChild(statsCard);
      inner.appendChild(nav);
      container.appendChild(inner);
      main.appendChild(container);

      updateStatsText();
      applyTheme(currentConfig);
      applyTypography(currentConfig);
    }

    // -------- QUIZ SYSTEM (RATIO QUESTIONS) --------
    const ratioTopics = [
      "konsep_rasio",
      "kesamaan_rasio",
      "rasio_bagian_keseluruhan",
      "rasio_durasi_waktu",
      "perkalian_proporsi",
      "pembagian_proporsi"
    ];

    function generateRatioQuestion(difficulty, topic) {
      // difficulty: very_easy (C2), easy (C3), medium (C4), hard (C5), very_hard (C6)
      // C2 = Memahami, C3 = Menerapkan, C4 = Menganalisis, C5 = Mengevaluasi, C6 = Mencipta
      const allTopics = ratioTopics;
      const chosenTopic = topic && allTopics.includes(topic) ? topic : allTopics[randomInt(0, allTopics.length - 1)];

      let questionText = "";
      let correctAnswer = "";
      let explanation = "";
      let answerType = "exact"; // "exact" or "ratio"

      // Helper untuk GCD
      const gcd = (x,y) => y===0 ? x : gcd(y, x%y);

      // C2 - MEMAHAMI: Identifikasi dan sederhanakan rasio sederhana
      if (difficulty === "very_easy") {
        if (chosenTopic === "konsep_rasio") {
          const factor = randomInt(2, 4);
          const base1 = randomInt(2, 5);
          const base2 = randomInt(2, 5);
          const a = base1 * factor;
          const b = base2 * factor;
          questionText = `Sederhanakan rasio ${a}:${b} ke bentuk paling sederhana.\n\nContoh: Rasio 6:9 dapat disederhanakan menjadi 2:3 (dibagi 3)`;
          const g = gcd(a, b);
          correctAnswer = `${a/g}:${b/g}`;
          explanation = `Langkah penyelesaian:\n1. Cari FPB dari ${a} dan ${b} = ${g}\n2. Bagi kedua bilangan dengan FPB:\n   ${a} Ã· ${g} = ${a/g}\n   ${b} Ã· ${g} = ${b/g}\n3. Jadi rasio sederhananya adalah ${a/g}:${b/g}`;
          answerType = "ratio";
        } else if (chosenTopic === "kesamaan_rasio") {
          const a = randomInt(2, 6);
          const b = randomInt(2, 6);
          const factor = randomInt(2, 4);
          questionText = `Rasio ${a}:${b} setara dengan rasio berapa jika dikalikan ${factor}?\n\nContoh: Rasio 2:3 jika dikalikan 2 menjadi 4:6`;
          correctAnswer = `${a*factor}:${b*factor}`;
          explanation = `Langkah penyelesaian:\n1. Kalikan bilangan pertama: ${a} Ã— ${factor} = ${a*factor}\n2. Kalikan bilangan kedua: ${b} Ã— ${factor} = ${b*factor}\n3. Jadi rasio yang setara adalah ${a*factor}:${b*factor}`;
          answerType = "ratio";
        } else {
          // rasio_bagian_keseluruhan sederhana
          const bagian = randomInt(2, 5);
          const kelipatan = randomInt(3, 6);
          const total = bagian * kelipatan;
          questionText = `Dari ${total} buah apel, dibagi menjadi ${kelipatan} bagian yang sama. Berapa jumlah apel per bagian?\n\nContoh: 12 apel dibagi 3 bagian = 4 apel per bagian`;
          correctAnswer = String(bagian);
          explanation = `Langkah penyelesaian:\n1. Total apel = ${total}\n2. Jumlah bagian = ${kelipatan}\n3. Apel per bagian = ${total} Ã· ${kelipatan} = ${bagian} buah`;
        }
      }
      
      // C3 - MENERAPKAN: Gunakan rasio untuk menyelesaikan masalah langsung
      else if (difficulty === "easy") {
        if (chosenTopic === "rasio_bagian_keseluruhan") {
          const a = randomInt(2, 5);
          const b = randomInt(2, 5);
          const kelipatan = randomInt(2, 4);
          const total = (a + b) * kelipatan;
          questionText = `Perbandingan buku Matematika dan IPA adalah ${a}:${b}. Jika total ada ${total} buku, berapa buku Matematika?\n\nContoh: Jika rasio 2:3 dengan total 10, maka bagian pertama = 2/(2+3) Ã— 10 = 4`;
          const matematika = (a * total) / (a + b);
          correctAnswer = String(matematika);
          explanation = `Langkah penyelesaian:\n1. Total bagian = ${a} + ${b} = ${a+b}\n2. Bagian Matematika = ${a}/${a+b} dari total\n3. Buku Matematika = ${a}/${a+b} Ã— ${total} = ${matematika} buku`;
        } else if (chosenTopic === "perkalian_proporsi") {
          const orang1 = randomInt(2, 5);
          const perOrang = randomInt(2, 5) * 10;
          const orang2 = orang1 * randomInt(2, 3);
          questionText = `${orang1} orang membutuhkan ${orang1 * perOrang} ml air. Berapa ml air untuk ${orang2} orang?\n\nContoh: Jika 2 orang butuh 40 ml, maka 4 orang butuh 80 ml`;
          const needed = orang2 * perOrang;
          correctAnswer = String(needed);
          explanation = `Langkah penyelesaian:\n1. Kebutuhan per orang = ${orang1 * perOrang} Ã· ${orang1} = ${perOrang} ml\n2. Untuk ${orang2} orang = ${orang2} Ã— ${perOrang} = ${needed} ml`;
        } else {
          // pembagian_proporsi sederhana
          const a = randomInt(2, 4);
          const b = randomInt(2, 4);
          const kelipatan = randomInt(5, 10) * 100;
          const totalUang = (a + b) * kelipatan;
          questionText = `Ani dan Budi membagi uang Rp${totalUang} dengan perbandingan ${a}:${b}. Berapa rupiah yang diterima Ani?\n\nContoh: Jika Rp1000 dibagi dengan rasio 2:3, maka:\n- Total bagian = 2 + 3 = 5 bagian\n- Bagian pertama = 2/5 Ã— 1000 = Rp400`;
          const bagian1 = (a * totalUang) / (a + b);
          correctAnswer = String(bagian1);
          explanation = `Langkah penyelesaian:\n1. Total bagian = ${a} + ${b} = ${a+b} bagian\n2. Bagian Ani = ${a}/${a+b} dari total uang\n3. Uang yang diterima Ani = ${a}/${a+b} Ã— Rp${totalUang} = Rp${bagian1}\n4. (Budi menerima ${b}/${a+b} Ã— Rp${totalUang} = Rp${totalUang - bagian1})`;
        }
      }
      
      // C4 - MENGANALISIS: Analisis hubungan antar rasio dan temukan pola
      else if (difficulty === "medium") {
        if (chosenTopic === "konsep_rasio") {
          const a = randomInt(3, 8);
          const b = randomInt(3, 8);
          const c = randomInt(2, 6);
          const total = (a + b + c) * randomInt(2, 4);
          questionText = `Rasio A:B:C adalah ${a}:${b}:${c}. Jika total ${total}, berapa selisih antara bagian terbesar dan terkecil?`;
          const parts = [a, b, c].sort((x,y) => x-y);
          const perBagian = total / (a + b + c);
          const terbesar = parts[2] * perBagian;
          const terkecil = parts[0] * perBagian;
          const selisih = terbesar - terkecil;
          correctAnswer = String(selisih);
          explanation = `Per bagian = ${total}/${a+b+c} = ${perBagian}. Terbesar = ${parts[2]}Ã—${perBagian} = ${terbesar}, Terkecil = ${parts[0]}Ã—${perBagian} = ${terkecil}. Selisih = ${selisih}`;
        } else if (chosenTopic === "rasio_durasi_waktu") {
          const a = randomInt(2, 5);
          const b = randomInt(2, 5);
          const waktu1 = a * randomInt(3, 6) * 10;
          questionText = `Rasio waktu kerja Ani dan Budi adalah ${a}:${b}. Jika Ani bekerja ${waktu1} menit, berapa total waktu keduanya?`;
          const perBagian = waktu1 / a;
          const waktiBudi = b * perBagian;
          const totalWaktu = waktu1 + waktiBudi;
          correctAnswer = String(totalWaktu);
          explanation = `Per bagian = ${waktu1}/${a} = ${perBagian} menit. Budi = ${b}Ã—${perBagian} = ${waktiBudi} menit. Total = ${totalWaktu} menit`;
        } else {
          // kesamaan_rasio dengan analisis
          const a = randomInt(3, 7);
          const b = randomInt(3, 7);
          const hasil1 = a * randomInt(4, 8);
          questionText = `Jika ${a}:${b} = ${hasil1}:x, maka nilai x adalah...`;
          const x = (hasil1 * b) / a;
          correctAnswer = String(x);
          explanation = `Gunakan perkalian silang: ${a}Ã—x = ${b}Ã—${hasil1}, maka x = ${hasil1}Ã—${b}/${a} = ${x}`;
        }
      }
      
      // C5 - MENGEVALUASI: Evaluasi dan bandingkan beberapa rasio
      else if (difficulty === "hard") {
        if (chosenTopic === "pembagian_proporsi") {
          const a = randomInt(2, 5);
          const b = randomInt(2, 5);
          const c = randomInt(2, 5);
          const kelipatan = randomInt(10, 20) * 100;
          const total = (a + b + c) * kelipatan;
          questionText = `Uang Rp${total} dibagi untuk A, B, C dengan rasio ${a}:${b}:${c}. Jika B dan C digabung, berapa selisihnya dengan A?`;
          const perBagian = total / (a + b + c);
          const bagianA = a * perBagian;
          const bagianBC = (b + c) * perBagian;
          const selisih = Math.abs(bagianBC - bagianA);
          correctAnswer = String(selisih);
          explanation = `A = ${a}Ã—${perBagian} = Rp${bagianA}. B+C = ${b+c}Ã—${perBagian} = Rp${bagianBC}. Selisih = Rp${selisih}`;
        } else if (chosenTopic === "perkalian_proporsi") {
          const hari1 = randomInt(2, 5);
          const orang1 = randomInt(3, 6);
          const hari2 = randomInt(2, 5);
          const total = hari1 * orang1 * randomInt(4, 8);
          questionText = `${orang1} pekerja menyelesaikan pekerjaan dalam ${hari1} hari (total ${total} unit). Berapa pekerja dibutuhkan untuk ${hari2} hari dengan hasil sama?`;
          const perHariPerOrang = total / (hari1 * orang1);
          const orang2 = total / (hari2 * perHariPerOrang);
          correctAnswer = String(orang2);
          explanation = `Produktivitas per orang per hari = ${total}/(${hari1}Ã—${orang1}) = ${perHariPerOrang}. Pekerja = ${total}/(${hari2}Ã—${perHariPerOrang}) = ${orang2} orang`;
        } else {
          // rasio_bagian_keseluruhan kompleks
          const a = randomInt(3, 6);
          const b = randomInt(3, 6);
          const tambahan = randomInt(10, 20);
          const kelipatan = randomInt(3, 6);
          const total1 = (a + b) * kelipatan;
          questionText = `Rasio siswa laki-laki dan perempuan ${a}:${b} dengan total ${total1}. Jika ditambah ${tambahan} perempuan, berapa rasio baru laki-laki?`;
          const perBagian = total1 / (a + b);
          const lakiLaki = a * perBagian;
          const perempuanBaru = b * perBagian + tambahan;
          const g = gcd(lakiLaki, perempuanBaru);
          correctAnswer = `${lakiLaki/g}:${perempuanBaru/g}`;
          explanation = `Laki-laki = ${lakiLaki}, Perempuan baru = ${perempuanBaru}. Rasio = ${lakiLaki/g}:${perempuanBaru/g}`;
          answerType = "ratio";
        }
      }
      
      // C6 - MENCIPTA: Rancang solusi untuk masalah kompleks multi-langkah
      else if (difficulty === "very_hard") {
        if (chosenTopic === "konsep_rasio") {
          const a = randomInt(2, 4);
          const b = randomInt(2, 4);
          const c = randomInt(2, 4);
          const persenA = randomInt(20, 40);
          const kelipatan = randomInt(5, 10) * 10;
          const total = (a + b + c) * kelipatan;
          questionText = `Rasio A:B:C = ${a}:${b}:${c} dengan total ${total}. Jika A dikurangi ${persenA}%, berapa jumlah B dan C harus ditambah agar total tetap?`;
          const perBagian = total / (a + b + c);
          const nilaiA = a * perBagian;
          const penguranganA = (persenA / 100) * nilaiA;
          const tambahBC = penguranganA;
          correctAnswer = String(tambahBC);
          explanation = `A = ${nilaiA}, dikurangi ${persenA}% = ${penguranganA}. B dan C harus ditambah total ${tambahBC} agar total tetap ${total}`;
        } else if (chosenTopic === "pembagian_proporsi") {
          const a = randomInt(2, 4);
          const b = randomInt(2, 4);
          const c = randomInt(2, 4);
          const targetB = randomInt(200, 400) * 10;
          questionText = `Uang dibagi A:B:C = ${a}:${b}:${c}. Jika B harus menerima Rp${targetB}, berapa total uang minimum yang dibutuhkan?`;
          const perBagian = targetB / b;
          const totalUang = (a + b + c) * perBagian;
          correctAnswer = String(totalUang);
          explanation = `Jika B = Rp${targetB}, maka per bagian = ${targetB}/${b} = Rp${perBagian}. Total = ${a+b+c}Ã—${perBagian} = Rp${totalUang}`;
        } else {
          // Multi-step proportion problem
          const kecepatan1 = randomInt(40, 60);
          const waktu1 = randomInt(2, 4);
          const jarak = kecepatan1 * waktu1;
          const kecepatan2 = randomInt(30, 50);
          questionText = `Mobil A berkecepatan ${kecepatan1} km/jam menempuh ${jarak} km dalam ${waktu1} jam. Jika Mobil B berkecepatan ${kecepatan2} km/jam, berapa jam untuk jarak yang sama?`;
          const waktu2 = jarak / kecepatan2;
          correctAnswer = String(waktu2);
          explanation = `Jarak = ${jarak} km. Waktu Mobil B = ${jarak}/${kecepatan2} = ${waktu2} jam`;
        }
      }

      return {
        text: questionText,
        answer: correctAnswer,
        explanation,
        topic: chosenTopic,
        difficulty,
        answerType
      };
    }

    function openQuizScreen() {
      const main = domRefs.mainWrapper;
      if (!main) return;
      main.innerHTML = "";

      const container = document.createElement("main");
      container.className = "flex-1 w-full flex flex-col items-center";
      container.setAttribute("role", "main");

      const inner = document.createElement("div");
      inner.className = "max-w-4xl w-full mx-auto px-4 py-6";

      const header = document.createElement("header");
      header.className = "mb-4 flex items-center justify-between";
      const h2 = document.createElement("h2");
      h2.className = "text-2xl font-bold text-main body-text";
      h2.textContent = "Mode Quiz Rasio";
      const backBtn = document.createElement("button");
      backBtn.type = "button";
      backBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      backBtn.textContent = "Kembali";
      backBtn.addEventListener("click", (e) => {
        e.preventDefault();
        renderHomeScreen();
      });
      header.appendChild(h2);
      header.appendChild(backBtn);

      // Filters
      const filterSection = document.createElement("section");
      filterSection.className = "surface-card rounded-lg p-4 mb-4 shadow body-text";
      const filterTitle = document.createElement("h3");
      filterTitle.className = "font-semibold mb-3";
      filterTitle.textContent = "Filter Soal";

      const filterForm = document.createElement("form");
      filterForm.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
      filterForm.addEventListener("submit", (e) => e.preventDefault());

      // Difficulty select
      const diffWrap = document.createElement("div");
      const diffLabel = document.createElement("label");
      diffLabel.className = "block mb-1 label-text";
      diffLabel.setAttribute("for", "select-diff");
      diffLabel.textContent = "Tingkat Kesulitan";
      const diffSelect = document.createElement("select");
      diffSelect.id = "select-diff";
      diffSelect.className = "w-full border rounded px-2 py-1 body-text";
      const diffOptions = [
        { value: "very_easy", label: "C2 - Memahami (Common)" },
        { value: "easy", label: "C3 - Menerapkan (Uncommon)" },
        { value: "medium", label: "C4 - Menganalisis (Rare)" },
        { value: "hard", label: "C5 - Mengevaluasi (Legendary)" },
        { value: "very_hard", label: "C6 - Mencipta (Mythical)" }
      ];
      diffOptions.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        diffSelect.appendChild(opt);
      });
      diffWrap.appendChild(diffLabel);
      diffWrap.appendChild(diffSelect);

      // Topic select
      const topicWrap = document.createElement("div");
      const topicLabel = document.createElement("label");
      topicLabel.className = "block mb-1 label-text";
      topicLabel.setAttribute("for", "select-topic");
      topicLabel.textContent = "Topik Rasio";
      const topicSelect = document.createElement("select");
      topicSelect.id = "select-topic";
      topicSelect.className = "w-full border rounded px-2 py-1 body-text";
      const topicOptions = [
        { value: "", label: "Acak" },
        { value: "konsep_rasio", label: "Konsep Rasio" },
        { value: "kesamaan_rasio", label: "Kesamaan Rasio" },
        { value: "rasio_bagian_keseluruhan", label: "Rasio Bagian : Keseluruhan" },
        { value: "rasio_durasi_waktu", label: "Rasio Durasi Waktu" },
        { value: "perkalian_proporsi", label: "Proporsi (Perkalian)" },
        { value: "pembagian_proporsi", label: "Proporsi (Pembagian)" }
      ];
      topicOptions.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        topicSelect.appendChild(opt);
      });

      topicWrap.appendChild(topicLabel);
      topicWrap.appendChild(topicSelect);

      filterForm.appendChild(diffWrap);
      filterForm.appendChild(topicWrap);

      filterSection.appendChild(filterTitle);
      filterSection.appendChild(filterForm);

      // Question area
      const questionSection = document.createElement("section");
      questionSection.className = "surface-card rounded-lg p-4 mb-4 shadow body-text";
      const qText = document.createElement("p");
      qText.id = "quiz-question-text";
      qText.className = "mb-3";
      qText.textContent = "Klik \"Soal Baru\" untuk mulai.";
      const answerForm = document.createElement("form");
      answerForm.className = "mt-2 flex flex-col md:flex-row gap-3 items-start md:items-center";
      const ansWrap = document.createElement("div");
      ansWrap.className = "flex-1";
      const ansLabel = document.createElement("label");
      ansLabel.className = "block mb-1 label-text";
      ansLabel.setAttribute("for", "quiz-answer");
      ansLabel.textContent = "Jawabanmu";
      const ansInput = document.createElement("input");
      ansInput.id = "quiz-answer";
      ansInput.type = "text";
      ansInput.className = "w-full border rounded px-2 py-1 body-text";
      ansWrap.appendChild(ansLabel);
      ansWrap.appendChild(ansInput);

      const submitBtn = document.createElement("button");
      submitBtn.type = "submit";
      submitBtn.className = "btn-primary rounded px-4 py-2 font-semibold label-text";
      submitBtn.textContent = "Kirim Jawaban";

      answerForm.appendChild(ansWrap);
      answerForm.appendChild(submitBtn);

      const feedbackP = document.createElement("p");
      feedbackP.id = "quiz-feedback";
      feedbackP.className = "mt-3 caption-text";

      const answerKeySection = document.createElement("div");
      answerKeySection.id = "answer-key-section";
      answerKeySection.className = "mt-3 p-3 border-2 rounded";
      answerKeySection.style.display = "none";
      answerKeySection.style.borderColor = currentConfig.secondary_color || defaultConfig.secondary_color;
      answerKeySection.style.backgroundColor = "rgba(59, 130, 246, 0.1)";
      
      const answerKeyTitle = document.createElement("p");
      answerKeyTitle.className = "font-semibold label-text mb-2";
      answerKeyTitle.textContent = "ðŸ”‘ Kunci Jawaban (Ctrl+M untuk tutup)";
      
      const answerKeyContent = document.createElement("p");
      answerKeyContent.id = "answer-key-content";
      answerKeyContent.className = "caption-text";
      answerKeyContent.style.whiteSpace = "pre-wrap";
      
      answerKeySection.appendChild(answerKeyTitle);
      answerKeySection.appendChild(answerKeyContent);

      const newQuestionBtn = document.createElement("button");
      newQuestionBtn.type = "button";
      newQuestionBtn.className = "btn-secondary border-2 rounded px-4 py-2 mt-3 label-text";
      newQuestionBtn.textContent = "Soal Baru";

      questionSection.appendChild(qText);
      questionSection.appendChild(answerForm);
      questionSection.appendChild(feedbackP);
      questionSection.appendChild(answerKeySection);
      questionSection.appendChild(newQuestionBtn);

      // Current question state
      let currentQuestion = null;
      let isProcessing = false;
      let answerKeyVisible = false;

      function generateAndShowQuestion() {
        const diff = diffSelect.value || "very_easy";
        const topicVal = topicSelect.value || "";
        currentQuestion = generateRatioQuestion(diff, topicVal || null);
        qText.textContent = currentQuestion.text;
        qText.style.whiteSpace = "pre-wrap";
        ansInput.value = "";
        feedbackP.textContent = "";
        answerKeySection.style.display = "none";
        answerKeyVisible = false;
      }

      function toggleAnswerKey() {
        if (!currentQuestion) {
          showToast("Silakan buat soal terlebih dahulu.", "info");
          return;
        }
        answerKeyVisible = !answerKeyVisible;
        if (answerKeyVisible) {
          answerKeySection.style.display = "block";
          answerKeyContent.textContent = `Jawaban: ${currentQuestion.answer}\n\n${currentQuestion.explanation}`;
          showToast("Kunci jawaban ditampilkan", "info");
        } else {
          answerKeySection.style.display = "none";
          showToast("Kunci jawaban disembunyikan", "info");
        }
      }

      // Keyboard shortcut Ctrl+M
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "m") {
          e.preventDefault();
          toggleAnswerKey();
        }
      });

      newQuestionBtn.addEventListener("click", (e) => {
        e.preventDefault();
        generateAndShowQuestion();
      });

      answerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentQuestion) {
          showToast("Silakan klik \"Soal Baru\" terlebih dahulu.", "info");
          return;
        }
        if (isProcessing) return;
        isProcessing = true;

        const userAns = ansInput.value.trim();
        if (!userAns) {
          showToast("Jawaban tidak boleh kosong.", "error");
          isProcessing = false;
          return;
        }

        appStats.questionsAnswered += 1;

        const correctAnsRaw = currentQuestion.answer.trim();
        const normalizedCorrect = correctAnsRaw.replace(/\s+/g, "");
        const normalizedUser = userAns.replace(/\s+/g, "");

        // Check if answer is correct (support equivalent ratios)
        let isCorrect = false;
        if (currentQuestion.answerType === "ratio") {
          // Parse ratio format "a:b"
          const parseRatio = (str) => {
            const parts = str.split(":").map(p => parseFloat(p.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
              return parts;
            }
            return null;
          };
          
          const correctRatio = parseRatio(normalizedCorrect);
          const userRatio = parseRatio(normalizedUser);
          
          if (correctRatio && userRatio) {
            // Check if ratios are equivalent: a/b = c/d
            const correctValue = correctRatio[0] / correctRatio[1];
            const userValue = userRatio[0] / userRatio[1];
            // Allow small floating point tolerance
            isCorrect = Math.abs(correctValue - userValue) < 0.0001;
          }
        } else {
          // For non-ratio answers, exact match
          isCorrect = normalizedCorrect === normalizedUser;
        }
        if (isCorrect) {
          appStats.correctAnswers += 1;
          appStats.currentWrongStreak = 0;
          feedbackP.textContent = "âœ… Jawaban Benar!";
          feedbackP.style.color = "#10b981";
          showToast("Jawaban benar! Kamu berpeluang menangkap Pokemon.", "success");

          // Capture Pokemon based on difficulty
          const rarity = getRarityByDifficulty(currentQuestion.difficulty);
          await handleCapturePokemon(rarity);
        } else {
          appStats.currentWrongStreak += 1;
          feedbackP.textContent = `âŒ Jawaban Belum Tepat. Tekan Ctrl+M untuk melihat kunci jawaban.`;
          feedbackP.style.color = "#ef4444";
          showToast("Jawaban salah, coba lagi!", "error");

          // 3x salah berturut-turut => release random pokemon
          if (appStats.currentWrongStreak >= 3) {
            appStats.currentWrongStreak = 0;
            await handleReleaseRandomPokemon();
          }
        }

        saveLocalStats();
        updateStatsText();
        isProcessing = false;
      });

      inner.appendChild(header);
      inner.appendChild(filterSection);
      inner.appendChild(questionSection);
      container.appendChild(inner);
      main.appendChild(container);

      applyTheme(currentConfig);
      applyTypography(currentConfig);
    }

    async function handleCapturePokemon(rarity) {
      // Try to initialize SDK if not already done
      if (!dataInitialized) {
        await initDataSdk();
      }
      
      // Check limit
      if (currentRecordCount >= 999) {
        showToast("Koleksi Pokemon sudah mencapai batas 999.", "error");
        return;
      }

      const captureButton = document.querySelector(".pokeball-btn");
      if (captureButton) {
        captureButton.classList.add("capture-anim");
        setTimeout(() => captureButton.classList.remove("capture-anim"), 700);
      }

      showToast("Menangkap Pokemon...", "info");

      const pokemonData = await fetchRandomPokemon(rarity);
      const code = generatePokemonCode();
      const record = {
        code,
        name: pokemonData.name,
        sprite: pokemonData.sprite,
        rarity: pokemonData.rarity,
        hp: pokemonData.hp,
        atk: pokemonData.atk,
        speed: pokemonData.speed,
        captured_at: new Date().toISOString()
      };

      let result;
      if (useLocalStorageMode) {
        result = createPokemonLocalStorage(record);
      } else {
        result = await window.dataSdk.create(record);
      }

      if (result.isOk) {
        showToast(`Berhasil menangkap ${pokemonData.name} [${rarity}]!`, "success");
        // Show capture popup with Pokemon details
        openPokemonDetailModal(record, true);
      } else {
        showToast("Gagal menyimpan Pokemon yang ditangkap.", "error");
      }
    }

    async function handleReleaseRandomPokemon() {
      if (!dataInitialized) {
        await initDataSdk();
      }
      if (!allPokemonRecords.length) {
        showToast("Kamu tidak punya Pokemon untuk dilepas.", "info");
        return;
      }
      const idx = randomInt(0, allPokemonRecords.length - 1);
      const target = allPokemonRecords[idx];
      
      let result;
      if (useLocalStorageMode) {
        result = deletePokemonLocalStorage(target);
      } else {
        result = await window.dataSdk.delete(target);
      }

      if (result.isOk) {
        appStats.totalReleased += 1;
        saveLocalStats();
        showToast(`Karena tiga kali salah, Pokemon ${target.name} (${target.code}) dilepas.`, "info");
      } else {
        showToast("Gagal melepas Pokemon.", "error");
      }
    }

    // -------- COLLECTION SCREEN --------
    function renderCollectionListInto(container) {
      container.innerHTML = "";
      if (!allPokemonRecords.length) {
        const empty = document.createElement("p");
        empty.className = "caption-text text-main";
        empty.textContent = "Koleksi Pokemon masih kosong.";
        container.appendChild(empty);
        return;
      }

      const grid = document.createElement("div");
      grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4";

      allPokemonRecords.forEach(rec => {
        const card = document.createElement("button");
        card.type = "button";
        card.className = "pokemon-card surface-card rounded-lg p-3 shadow flex flex-col items-center text-left focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500";
        card.style.border = `2px solid ${rarityColors[rec.rarity] || "#9ca3af"}`;
        card.dataset.code = rec.code;

        // Pokemon image
        if (rec.sprite) {
          const img = document.createElement("img");
          img.src = rec.sprite;
          img.alt = rec.name;
          img.className = "w-20 h-20 object-contain mb-2";
          img.onerror = function() {
            this.style.display = 'none';
          };
          card.appendChild(img);
        }

        const name = document.createElement("p");
        name.className = "font-semibold text-main body-text mb-1 capitalize text-center";
        name.textContent = `${rec.name}`;

        const rarityBadge = document.createElement("span");
        rarityBadge.className = "caption-text mb-1 px-2 py-1 rounded";
        rarityBadge.textContent = rec.rarity;
        rarityBadge.style.backgroundColor = rarityColors[rec.rarity] || "#9ca3af";
        rarityBadge.style.color = "#ffffff";
        rarityBadge.style.fontSize = "0.7rem";

        const code = document.createElement("p");
        code.className = "caption-text text-main mb-1";
        code.textContent = rec.code;

        const stats = document.createElement("p");
        stats.className = "caption-text text-main text-center";
        stats.textContent = `HP: ${rec.hp} | ATK: ${rec.atk} | SPD: ${rec.speed}`;

        card.appendChild(name);
        card.appendChild(rarityBadge);
        card.appendChild(code);
        card.appendChild(stats);

        card.addEventListener("click", (e) => {
          e.preventDefault();
          openPokemonDetailModal(rec);
        });

        grid.appendChild(card);
      });

      container.appendChild(grid);
    }

    function openPokemonDetailModal(rec, isCapture = false) {
      const existing = document.getElementById("modal-overlay");
      if (existing) existing.remove();

      const overlay = document.createElement("div");
      overlay.id = "modal-overlay";
      overlay.className = "fixed inset-0 z-50 flex items-center justify-center p-4";
      overlay.style.backgroundColor = "rgba(0,0,0,0.7)";

      const dialog = document.createElement("div");
      dialog.className = "surface-card rounded-lg p-6 max-w-md w-full shadow-lg body-text";
      dialog.setAttribute("role", "dialog");
      dialog.setAttribute("aria-modal", "true");

      if (isCapture) {
        const captureTitle = document.createElement("h2");
        captureTitle.className = "text-2xl font-bold mb-3 text-center text-main";
        captureTitle.textContent = "ðŸŽ‰ Pokemon Tertangkap! ðŸŽ‰";
        dialog.appendChild(captureTitle);
      }

      // Pokemon image
      if (rec.sprite) {
        const imgContainer = document.createElement("div");
        imgContainer.className = "flex justify-center mb-3";
        const img = document.createElement("img");
        img.src = rec.sprite;
        img.alt = rec.name;
        img.className = "w-32 h-32 object-contain";
        img.onerror = function() {
          this.style.display = 'none';
        };
        imgContainer.appendChild(img);
        dialog.appendChild(imgContainer);
      }

      const title = document.createElement("h3");
      title.className = "text-xl font-bold mb-2 text-main capitalize text-center";
      title.textContent = rec.name;

      const rarityP = document.createElement("p");
      rarityP.className = "caption-text text-main mb-1 text-center";
      rarityP.textContent = `Rarity: ${rec.rarity}`;
      rarityP.style.color = rarityColors[rec.rarity] || "#9ca3af";
      rarityP.style.fontWeight = "bold";

      const codeP = document.createElement("p");
      codeP.className = "caption-text text-main mb-1 text-center";
      codeP.textContent = `Kode: ${rec.code}`;

      const statsP = document.createElement("p");
      statsP.className = "caption-text text-main mb-3 text-center";
      statsP.textContent = `HP: ${rec.hp} | ATK: ${rec.atk} | SPD: ${rec.speed}`;

      const btnRow = document.createElement("div");
      btnRow.className = "flex justify-center gap-2 mt-4";

      const closeBtn = document.createElement("button");
      closeBtn.type = "button";
      closeBtn.className = "btn-primary rounded px-4 py-2 label-text";
      closeBtn.textContent = isCapture ? "Lanjutkan" : "Tutup";
      closeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        overlay.remove();
      });

      btnRow.appendChild(closeBtn);

      dialog.appendChild(title);
      dialog.appendChild(rarityP);
      dialog.appendChild(codeP);
      dialog.appendChild(statsP);
      dialog.appendChild(btnRow);

      overlay.appendChild(dialog);
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay && !isCapture) overlay.remove();
      });

      document.body.appendChild(overlay);
      applyTheme(currentConfig);
      applyTypography(currentConfig);
    }

    function openCollectionScreen() {
      const main = domRefs.mainWrapper;
      if (!main) return;
      main.innerHTML = "";

      const container = document.createElement("main");
      container.className = "flex-1 w-full flex flex-col items-center";
      container.setAttribute("role", "main");

      const inner = document.createElement("div");
      inner.className = "max-w-4xl w-full mx-auto px-4 py-6";

      const header = document.createElement("header");
      header.className = "mb-4 flex items-center justify-between";
      const h2 = document.createElement("h2");
      h2.className = "text-2xl font-bold text-main body-text";
      h2.textContent = "Koleksi Pokemon";
      const backBtn = document.createElement("button");
      backBtn.type = "button";
      backBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      backBtn.textContent = "Kembali";
      backBtn.addEventListener("click", (e) => {
        e.preventDefault();
        renderHomeScreen();
      });
      header.appendChild(h2);
      header.appendChild(backBtn);

      const section = document.createElement("section");
      section.className = "surface-card rounded-lg p-4 shadow body-text";
      const listContainer = document.createElement("div");
      listContainer.id = "collection-list";

      section.appendChild(listContainer);

      inner.appendChild(header);
      inner.appendChild(section);
      container.appendChild(inner);
      main.appendChild(container);

      renderCollectionListInto(listContainer);
      applyTheme(currentConfig);
      applyTypography(currentConfig);
    }

    // -------- DUEL MODE --------
    function openDuelScreen() {
      const main = domRefs.mainWrapper;
      if (!main) return;
      main.innerHTML = "";

      const container = document.createElement("main");
      container.className = "flex-1 w-full flex flex-col items-center";
      container.setAttribute("role", "main");

      const inner = document.createElement("div");
      inner.className = "max-w-4xl w-full mx-auto px-4 py-6";

      const header = document.createElement("header");
      header.className = "mb-4 flex items-center justify-between";
      const h2 = document.createElement("h2");
      h2.className = "text-2xl font-bold text-main body-text";
      h2.textContent = "Mode Duel";
      const backBtn = document.createElement("button");
      backBtn.type = "button";
      backBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      backBtn.textContent = "Kembali";
      backBtn.addEventListener("click", (e) => {
        e.preventDefault();
        renderHomeScreen();
      });
      header.appendChild(h2);
      header.appendChild(backBtn);

      const tabs = document.createElement("div");
      tabs.className = "flex gap-2 mb-4";
      const tabPlayer = document.createElement("button");
      tabPlayer.type = "button";
      tabPlayer.className = "btn-primary rounded px-3 py-1 label-text";
      tabPlayer.textContent = "Duel Pemain";
      const tabStory = document.createElement("button");
      tabStory.type = "button";
      tabStory.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      tabStory.textContent = "Duel Story";

      tabs.appendChild(tabPlayer);
      tabs.appendChild(tabStory);

      const content = document.createElement("div");
      content.id = "duel-content";

      inner.appendChild(header);
      inner.appendChild(tabs);
      inner.appendChild(content);
      container.appendChild(inner);
      main.appendChild(container);

      function setActiveTab(name) {
        if (name === "player") {
          tabPlayer.className = "btn-primary rounded px-3 py-1 label-text";
          tabStory.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
          renderDuelPlayer(content);
        } else {
          tabStory.className = "btn-primary rounded px-3 py-1 label-text";
          tabPlayer.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
          renderDuelStory(content);
        }
        applyTheme(currentConfig);
        applyTypography(currentConfig);
      }

      tabPlayer.addEventListener("click", (e) => { e.preventDefault(); setActiveTab("player"); });
      tabStory.addEventListener("click", (e) => { e.preventDefault(); setActiveTab("story"); });

      setActiveTab("player");
      applyTheme(currentConfig);
      applyTypography(currentConfig);
    }

    function findPokemonByCode(code) {
      return allPokemonRecords.find(r => r.code.toUpperCase() === code.toUpperCase());
    }

    function renderDuelPlayer(container) {
      container.innerHTML = "";
      const wrapper = document.createElement("section");
      wrapper.className = "surface-card rounded-lg p-4 shadow body-text";

      const title = document.createElement("h3");
      title.className = "font-semibold mb-3";
      title.textContent = "Duel Pemain (Berdasarkan SPEED, jika sama â†’ ATK)";

      const form = document.createElement("form");
      form.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
      form.addEventListener("submit", (e) => e.preventDefault());

      const p1Wrap = document.createElement("div");
      const p1Label = document.createElement("label");
      p1Label.className = "block mb-1 label-text";
      p1Label.setAttribute("for", "duel-code-1");
      p1Label.textContent = "Kode Pokemon 1";
      const p1Input = document.createElement("input");
      p1Input.id = "duel-code-1";
      p1Input.type = "text";
      p1Input.className = "w-full border rounded px-2 py-1 body-text";
      p1Wrap.appendChild(p1Label);
      p1Wrap.appendChild(p1Input);

      const p2Wrap = document.createElement("div");
      const p2Label = document.createElement("label");
      p2Label.className = "block mb-1 label-text";
      p2Label.setAttribute("for", "duel-code-2");
      p2Label.textContent = "Kode Pokemon 2";
      const p2Input = document.createElement("input");
      p2Input.id = "duel-code-2";
      p2Input.type = "text";
      p2Input.className = "w-full border rounded px-2 py-1 body-text";
      p2Wrap.appendChild(p2Label);
      p2Wrap.appendChild(p2Input);

      form.appendChild(p1Wrap);
      form.appendChild(p2Wrap);

      const fightBtn = document.createElement("button");
      fightBtn.type = "button";
      fightBtn.className = "btn-primary rounded px-4 py-2 mt-3 label-text";
      fightBtn.textContent = "Mulai Duel";

      const resultP = document.createElement("p");
      resultP.className = "mt-3 caption-text";

      fightBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const code1 = p1Input.value.trim();
        const code2 = p2Input.value.trim();
        if (!code1 || !code2) {
          showToast("Masukkan kedua kode Pokemon.", "error");
          return;
        }
        const p1 = findPokemonByCode(code1);
        const p2 = findPokemonByCode(code2);
        if (!p1 || !p2) {
          showToast("Kode Pokemon tidak ditemukan di koleksi.", "error");
          return;
        }

        if (p1.speed > p2.speed) {
          resultP.textContent = `${p1.name} (${p1.code}) MENANG dengan SPEED ${p1.speed} melawan ${p2.speed}.`;
        } else if (p2.speed > p1.speed) {
          resultP.textContent = `${p2.name} (${p2.code}) MENANG dengan SPEED ${p2.speed} melawan ${p1.speed}.`;
        } else {
          // tie in speed -> compare atk
          if (p1.atk > p2.atk) {
            resultP.textContent = `${p1.name} (${p1.code}) MENANG (SPEED sama, ATK ${p1.atk} > ${p2.atk}).`;
          } else if (p2.atk > p1.atk) {
            resultP.textContent = `${p2.name} (${p2.code}) MENANG (SPEED sama, ATK ${p2.atk} > ${p1.atk}).`;
          } else {
            resultP.textContent = "Duel imbang! SPEED dan ATK sama.";
          }
        }
      });

      wrapper.appendChild(title);
      wrapper.appendChild(form);
      wrapper.appendChild(fightBtn);
      wrapper.appendChild(resultP);

      container.appendChild(wrapper);
    }

    function getEnemyRarityForStreak(streak) {
      if (streak < 10) return "uncommon";
      if (streak < 20) return "common";
      if (streak < 30) return "rare";
      if (streak < 40) return "legendary";
      return "mythical";
    }

    function getRewardForStreak(streak) {
      if (streak === 10) return "uncommon";
      if (streak === 20) return "common";
      if (streak === 30) return "rare";
      if (streak === 40) return "legendary";
      if (streak === 50) return "mythical";
      return null;
    }

    function renderDuelStory(container) {
      container.innerHTML = "";
      const wrapper = document.createElement("section");
      wrapper.className = "surface-card rounded-lg p-4 shadow body-text";

      const title = document.createElement("h3");
      title.className = "font-semibold mb-3";
      title.textContent = "Duel Story";

      const selectedInfo = document.createElement("p");
      selectedInfo.className = "caption-text mb-2";
      selectedInfo.textContent = "Pilih Pokemon dari koleksi sebagai petarungmu.";

      const streakP = document.createElement("p");
      streakP.className = "caption-text mb-3";
      streakP.textContent = "Streak Menang: 0";

      const chooseBtn = document.createElement("button");
      chooseBtn.type = "button";
      chooseBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text mr-2";
      chooseBtn.textContent = "Pilih / Ganti Pokemon";

      const fightBtn = document.createElement("button");
      fightBtn.type = "button";
      fightBtn.className = "btn-primary rounded px-3 py-1 label-text";
      fightBtn.textContent = "Battle!";

      const resultP = document.createElement("p");
      resultP.className = "mt-3 caption-text";

      wrapper.appendChild(title);
      wrapper.appendChild(selectedInfo);
      wrapper.appendChild(streakP);
      wrapper.appendChild(chooseBtn);
      wrapper.appendChild(fightBtn);
      wrapper.appendChild(resultP);

      container.appendChild(wrapper);

      let currentFighter = null;
      let currentStreak = 0;

      function updateStreakDisplay() {
        streakP.textContent = `Streak Menang: ${currentStreak}`;
      }

      function openSelectModal() {
        if (!allPokemonRecords.length) {
          showToast("Koleksi kosong. Menangkan Pokemon dari quiz dulu.", "info");
          return;
        }
        const existing = document.getElementById("modal-overlay");
        if (existing) existing.remove();

        const overlay = document.createElement("div");
        overlay.id = "modal-overlay";
        overlay.className = "fixed inset-0 z-50 flex items-center justify-center p-4";
        overlay.style.backgroundColor = "rgba(0,0,0,0.8)";

        const dialog = document.createElement("div");
        dialog.className = "surface-card rounded-lg p-6 max-w-2xl w-full shadow-lg body-text";
        dialog.setAttribute("role", "dialog");
        dialog.setAttribute("aria-modal", "true");

        const h = document.createElement("h3");
        h.className = "text-xl font-bold mb-3 text-main";
        h.textContent = "Pilih Pokemon";

        const grid = document.createElement("div");
        grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-[70%] overflow-y-auto";

        allPokemonRecords.forEach(rec => {
          const card = document.createElement("button");
          card.type = "button";
          card.className = "pokemon-card surface-card rounded-lg p-3 shadow flex flex-col items-center text-left focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500";
          card.style.border = `2px solid ${rarityColors[rec.rarity] || "#9ca3af"}`;
          
          // Pokemon image
          if (rec.sprite) {
            const img = document.createElement("img");
            img.src = rec.sprite;
            img.alt = rec.name;
            img.className = "w-16 h-16 object-contain mb-2";
            img.onerror = function() {
              this.style.display = 'none';
            };
            card.appendChild(img);
          }
          
          const name = document.createElement("p");
          name.className = "font-semibold text-main body-text mb-1 capitalize text-center";
          name.textContent = rec.name;
          const code = document.createElement("p");
          code.className = "caption-text text-main mb-1 text-center";
          code.textContent = rec.code;
          const stats = document.createElement("p");
          stats.className = "caption-text text-main text-center";
          stats.textContent = `HP: ${rec.hp} | ATK: ${rec.atk} | SPD: ${rec.speed}`;
          card.appendChild(name);
          card.appendChild(code);
          card.appendChild(stats);
          card.addEventListener("click", (e) => {
            e.preventDefault();
            currentFighter = rec;
            selectedInfo.textContent = `Pokemon Terpilih: ${rec.name} (${rec.code})`;
            overlay.remove();
          });
          grid.appendChild(card);
        });

        const closeRow = document.createElement("div");
        closeRow.className = "flex justify-end mt-3";
        const closeBtn = document.createElement("button");
        closeBtn.type = "button";
        closeBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
        closeBtn.textContent = "Tutup";
        closeBtn.addEventListener("click", (e) => { e.preventDefault(); overlay.remove(); });
        closeRow.appendChild(closeBtn);

        dialog.appendChild(h);
        dialog.appendChild(grid);
        dialog.appendChild(closeRow);

        overlay.appendChild(dialog);
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.remove();
        });

        document.body.appendChild(overlay);
        applyTheme(currentConfig);
        applyTypography(currentConfig);
      }

      chooseBtn.addEventListener("click", (e) => {
        e.preventDefault();
        openSelectModal();
      });

      fightBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!currentFighter) {
          showToast("Pilih Pokemon terlebih dahulu.", "error");
          return;
        }

        // Determine enemy rarity by streak
        const enemyRarity = getEnemyRarityForStreak(currentStreak);
        const enemy = await fetchRandomPokemon(enemyRarity);

        // Compare SPEED then ATK
        let resultText = "";
        if (currentFighter.speed > enemy.speed) {
          resultText = `Kamu MENANG! ${currentFighter.name} (SPD ${currentFighter.speed}) mengalahkan ${enemy.name} (SPD ${enemy.speed}).`;
          currentStreak += 1;

          const rewardRarity = getRewardForStreak(currentStreak);
          if (rewardRarity) {
            await handleCapturePokemon(rewardRarity);
            showToast(`Hadiah streak ${currentStreak}: Pokemon ${rewardRarity}!`, "success");
          } else {
            showToast("Kamu menang! Lanjutkan streak untuk hadiah.", "success");
          }
        } else if (enemy.speed > currentFighter.speed) {
          resultText = `Kamu KALAH. ${enemy.name} (SPD ${enemy.speed}) mengalahkan ${currentFighter.name} (SPD ${currentFighter.speed}). Streak direset.`;
          currentStreak = 0;
          showToast("Streak berakhir. Coba lagi!", "error");
        } else {
          // speed same -> atk
          if (currentFighter.atk > enemy.atk) {
            resultText = `Kamu MENANG tipis! SPEED sama, tetapi ATK ${currentFighter.atk} > ${enemy.atk}.`;
            currentStreak += 1;
          } else if (enemy.atk > currentFighter.atk) {
            resultText = `Kamu KALAH tipis. SPEED sama, tetapi ATK musuh ${enemy.atk} > ${currentFighter.atk}.`;
            currentStreak = 0;
          } else {
            resultText = "Seri! SPEED dan ATK sama.";
          }
        }

        resultP.textContent = resultText;
        updateStreakDisplay();
      });

      updateStreakDisplay();
    }

    // -------- BACKUP / RESTORE (TEXT + QR + XLSX) --------
    function openBackupScreen() {
      const main = domRefs.mainWrapper;
      if (!main) return;
      main.innerHTML = "";

      const container = document.createElement("main");
      container.className = "flex-1 w-full flex flex-col items-center";
      container.setAttribute("role", "main");

      const inner = document.createElement("div");
      inner.className = "max-w-4xl w-full mx-auto px-4 py-6";

      const header = document.createElement("header");
      header.className = "mb-4 flex items-center justify-between";
      const h2 = document.createElement("h2");
      h2.className = "text-2xl font-bold text-main body-text";
      h2.textContent = "Backup & Restore";
      const backBtn = document.createElement("button");
      backBtn.type = "button";
      backBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      backBtn.textContent = "Kembali";
      backBtn.addEventListener("click", (e) => {
        e.preventDefault();
        renderHomeScreen();
      });
      header.appendChild(h2);
      header.appendChild(backBtn);

      const section = document.createElement("section");
      section.className = "surface-card rounded-lg p-4 shadow body-text";

      const desc = document.createElement("p");
      desc.className = "mb-3 caption-text";
      desc.textContent = "Backup mencakup koleksi Pokemon, statistik quiz, dan pengaturan.";

      // Text backup area
      const textAreaLabel = document.createElement("label");
      textAreaLabel.className = "block mb-1 label-text";
      textAreaLabel.setAttribute("for", "backup-text");
      textAreaLabel.textContent = "Data Backup (teks terkompresi)";

      const textArea = document.createElement("textarea");
      textArea.id = "backup-text";
      textArea.className = "w-full border rounded px-2 py-1 h-32 body-text mb-2";
      textArea.setAttribute("aria-label", "Data backup teks");

      const btnRow = document.createElement("div");
      btnRow.className = "flex flex-wrap gap-2 mb-3";

      const btnGenerate = document.createElement("button");
      btnGenerate.type = "button";
      btnGenerate.className = "btn-primary rounded px-3 py-1 label-text";
      btnGenerate.textContent = "Generate Backup";

      const btnRestore = document.createElement("button");
      btnRestore.type = "button";
      btnRestore.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      btnRestore.textContent = "Restore dari Teks";

      const btnXlsx = document.createElement("button");
      btnXlsx.type = "button";
      btnXlsx.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      btnXlsx.textContent = "Export Koleksi ke XLSX";

      btnRow.appendChild(btnGenerate);
      btnRow.appendChild(btnRestore);
      btnRow.appendChild(btnXlsx);

      // QR generate
      const qrTitle = document.createElement("p");
      qrTitle.className = "font-semibold mt-2 mb-1 label-text";
      qrTitle.textContent = "QR Backup";
      const qrContainer = document.createElement("div");
      qrContainer.id = "backup-qr";
      qrContainer.className = "border rounded p-2 inline-block";

      // QR scan
      const scanTitle = document.createElement("p");
      scanTitle.className = "font-semibold mt-4 mb-1 label-text";
      scanTitle.textContent = "Scan QR untuk Restore";
      const scanContainer = document.createElement("div");
      scanContainer.id = "qr-reader";
      scanContainer.className = "border rounded p-2";
      const scanResultP = document.createElement("p");
      scanResultP.className = "caption-text mt-1";

      section.appendChild(desc);
      section.appendChild(textAreaLabel);
      section.appendChild(textArea);
      section.appendChild(btnRow);
      section.appendChild(qrTitle);
      section.appendChild(qrContainer);
      section.appendChild(scanTitle);
      section.appendChild(scanContainer);
      section.appendChild(scanResultP);

      inner.appendChild(header);
      inner.appendChild(section);
      container.appendChild(inner);
      main.appendChild(container);

      // Load last backup if exist
      try {
        const savedBackup = window.localStorage.getItem(LS_KEYS.BACKUP_TEXT);
        if (savedBackup) textArea.value = savedBackup;
      } catch(e){}

      function buildBackupObject() {
        return {
          stats: appStats,
          settings: appSettings,
          pokemon: allPokemonRecords
        };
      }

      function applyBackupObject(obj) {
        if (obj.stats) {
          appStats = { ...defaultStats, ...obj.stats };
          saveLocalStats();
        }
        if (obj.settings) {
          appSettings = { ...defaultSettings, ...obj.settings };
          saveLocalSettings();
        }
        if (obj.pokemon && useLocalStorageMode) {
          // Only restore pokemon in localStorage mode
          allPokemonRecords = obj.pokemon;
          savePokemonToLocalStorage();
        }
        showToast("Backup berhasil diterapkan!", "success");
        updateStatsText();
        updateCollectionUI();
      }

      btnGenerate.addEventListener("click", (e) => {
        e.preventDefault();
        const obj = buildBackupObject();
        const json = JSON.stringify(obj);
        const compressed = LZString.compressToEncodedURIComponent(json);
        textArea.value = compressed;
        try {
          window.localStorage.setItem(LS_KEYS.BACKUP_TEXT, compressed);
        } catch(e){}
        // Generate QR
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
          text: compressed,
          width: 160,
          height: 160
        });
        showToast("Backup teks dan QR berhasil dibuat.", "success");
      });

      btnRestore.addEventListener("click", (e) => {
        e.preventDefault();
        const text = textArea.value.trim();
        if (!text) {
          showToast("Masukkan data backup terlebih dahulu.", "error");
          return;
        }
        try {
          const json = LZString.decompressFromEncodedURIComponent(text);
          const obj = JSON.parse(json);
          applyBackupObject(obj);
          showToast("Restore dari teks berhasil.", "success");
        } catch(err) {
          showToast("Format backup tidak valid.", "error");
        }
      });

      btnXlsx.addEventListener("click", (e) => {
        e.preventDefault();
        if (!allPokemonRecords.length) {
          showToast("Koleksi kosong, tidak ada yang diexport.", "info");
          return;
        }
        const wsData = [
          ["Code", "Name", "Rarity", "HP", "ATK", "SPD", "Captured At"]
        ];
        allPokemonRecords.forEach(r => {
          wsData.push([r.code, r.name, r.rarity, r.hp, r.atk, r.speed, r.captured_at]);
        });
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pokemon");
        XLSX.writeFile(wb, "pokemon_collection.xlsx");
      });

      // Initialize QR reader
      if (window.Html5Qrcode) {
        const html5QrCode = new Html5Qrcode("qr-reader");
        Html5Qrcode.getCameras().then(devices => {
          if (devices && devices.length) {
            const cameraId = devices[0].id;
            html5QrCode.start(
              cameraId,
              { fps: 10, qrbox: 200 },
              (decodedText, decodedResult) => {
                scanResultP.textContent = "QR terbaca, mencoba restore...";
                try {
                  const json = LZString.decompressFromEncodedURIComponent(decodedText);
                  const obj = JSON.parse(json);
                  applyBackupObject(obj);
                  showToast("Restore dari QR berhasil.", "success");
                } catch(err) {
                  showToast("QR tidak berisi backup yang valid.", "error");
                }
              },
              (errorMsg) => {
                // ignore scanning errors
              }
            ).catch(err => {
              scanResultP.textContent = "Tidak dapat mengakses kamera.";
            });
          } else {
            scanResultP.textContent = "Kamera tidak tersedia.";
          }
        }).catch(err => {
          scanResultP.textContent = "Gagal menginisialisasi kamera.";
        });
      } else {
        scanResultP.textContent = "html5-qrcode tidak tersedia.";
      }

      applyTheme(currentConfig);
      applyTypography(currentConfig);
    }

    // -------- SETTINGS --------
    function openSettingsScreen() {
      const main = domRefs.mainWrapper;
      if (!main) return;
      main.innerHTML = "";

      const container = document.createElement("main");
      container.className = "flex-1 w-full flex flex-col items-center";
      container.setAttribute("role", "main");

      const inner = document.createElement("div");
      inner.className = "max-w-4xl w-full mx-auto px-4 py-6";

      const header = document.createElement("header");
      header.className = "mb-4 flex items-center justify-between";
      const h2 = document.createElement("h2");
      h2.className = "text-2xl font-bold text-main body-text";
      h2.textContent = "Settings";
      const backBtn = document.createElement("button");
      backBtn.type = "button";
      backBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text";
      backBtn.textContent = "Kembali";
      backBtn.addEventListener("click", (e) => {
        e.preventDefault();
        renderHomeScreen();
      });
      header.appendChild(h2);
      header.appendChild(backBtn);

      const section = document.createElement("section");
      section.className = "surface-card rounded-lg p-4 shadow body-text";

      const modeInfo = document.createElement("p");
      modeInfo.className = "mb-3 caption-text";
      modeInfo.textContent = useLocalStorageMode ? "Mode: Browser (localStorage)" : "Mode: Canva (Canva Sheet)";

      const offlineWrap = document.createElement("div");
      offlineWrap.className = "flex items-center mb-3";
      const offlineLabel = document.createElement("label");
      offlineLabel.className = "label-text ml-2";
      offlineLabel.setAttribute("for", "offline-mode");
      offlineLabel.textContent = "Offline Mode (gunakan Pokemon dummy tanpa PokeAPI)";
      const offlineInput = document.createElement("input");
      offlineInput.id = "offline-mode";
      offlineInput.type = "checkbox";
      offlineInput.checked = !!appSettings.offlineMode;
      offlineInput.addEventListener("change", () => {
        appSettings.offlineMode = !!offlineInput.checked;
        saveLocalSettings();
        showToast("Pengaturan offline disimpan.", "success");
      });

      offlineWrap.appendChild(offlineInput);
      offlineWrap.appendChild(offlineLabel);

      const resetBtn = document.createElement("button");
      resetBtn.type = "button";
      resetBtn.className = "btn-secondary border-2 rounded px-3 py-1 label-text mt-2";
      resetBtn.textContent = "Reset Statistik & Pengaturan";
      const resetInfo = document.createElement("p");
      resetInfo.className = "caption-text mt-1";
      resetInfo.textContent = "Reset tidak menghapus koleksi Pokemon.";

      let resetConfirm = false;
      resetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        if (!resetConfirm) {
          resetConfirm = true;
          resetBtn.textContent = "Klik sekali lagi untuk konfirmasi";
          setTimeout(() => {
            resetConfirm = false;
            resetBtn.textContent = "Reset Statistik & Pengaturan";
          }, 2500);
          return;
        }
        appStats = { ...defaultStats };
        appSettings = { ...defaultSettings };
        saveLocalStats();
        saveLocalSettings();
        offlineInput.checked = appSettings.offlineMode;
        updateStatsText();
        showToast("Statistik dan pengaturan berhasil direset.", "success");
        resetConfirm = false;
        resetBtn.textContent = "Reset Statistik & Pengaturan";
      });

      section.appendChild(modeInfo);
      section.appendChild(offlineWrap);
      section.appendChild(resetBtn);
      section.appendChild(resetInfo);

      inner.appendChild(header);
      inner.appendChild(section);
      container.appendChild(inner);
      main.appendChild(container);

      applyTheme(currentConfig);
      applyTypography(currentConfig);
    }

    // -------- ELEMENT SDK INIT --------
    function initElementSdk() {
      if (!window.elementSdk) {
        // Render with default config when SDK not available
        currentConfig = { ...defaultConfig };
        loadLocalStats();
        loadLocalSettings();
        createBaseLayout();
        return;
      }

      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          currentConfig = { ...defaultConfig, ...config };
          // If app not yet rendered, do it now
          if (!domRefs.root) {
            loadLocalStats();
            loadLocalSettings();
            await initDataSdk();
            createBaseLayout();
          } else {
            // Update texts
            const titleEl = document.getElementById("app-title");
            if (titleEl) {
              titleEl.textContent = currentConfig.game_title || defaultConfig.game_title;
            }
            const subtitleEl = document.getElementById("app-subtitle");
            if (subtitleEl) {
              subtitleEl.textContent = currentConfig.welcome_message || defaultConfig.welcome_message;
            }
            const menuMap = {
              quiz: "menu_quiz",
              collection: "menu_collection",
              duel: "menu_duel",
              backup: "menu_backup"
            };
            Object.keys(menuMap).forEach(key => {
              const labelEl = domRefs.menuLabels[key];
              if (labelEl) {
                const cfgKey = menuMap[key];
                labelEl.textContent = currentConfig[cfgKey] || defaultConfig[cfgKey];
              }
            });
          }

          applyTheme(currentConfig);
          applyTypography(currentConfig);
        },
        mapToCapabilities: (config) => {
          const recolorables = [
            {
              get: () => window.elementSdk.config.background_color || defaultConfig.background_color,
              set: (value) => {
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => window.elementSdk.config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => window.elementSdk.config.text_color || defaultConfig.text_color,
              set: (value) => {
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => window.elementSdk.config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => window.elementSdk.config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                window.elementSdk.setConfig({ secondary_color: value });
              }
            }
          ];

          const fontEditable = {
            get: () => window.elementSdk.config.font_family || "system-ui",
            set: (value) => {
              window.elementSdk.setConfig({ font_family: value });
            }
          };

          const fontSizeable = {
            get: () => window.elementSdk.config.font_size || 16,
            set: (value) => {
              window.elementSdk.setConfig({ font_size: value });
            }
          };

          return {
            recolorables,
            borderables: [],
            fontEditable,
            fontSizeable
          };
        },
        mapToEditPanelValues: (config) => {
          const cfg = { ...defaultConfig, ...config };
          return new Map([
            ["game_title", cfg.game_title],
            ["welcome_message", cfg.welcome_message],
            ["menu_quiz", cfg.menu_quiz],
            ["menu_collection", cfg.menu_collection],
            ["menu_duel", cfg.menu_duel],
            ["menu_backup", cfg.menu_backup]
          ]);
        }
      });
    }

    // -------- APP INIT --------
    (async function initApp() {
      loadLocalStats();
      loadLocalSettings();
      
      // Initialize Element SDK first
      initElementSdk();
      
      // Try to initialize Data SDK (will fallback to localStorage if not available)
      await initDataSdk();
      
      // Create layout if not already done by Element SDK
      if (!domRefs.root) {
        createBaseLayout();
      }
    })();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a0d6ac6344baa81',t:'MTc2MzUzMTI5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
